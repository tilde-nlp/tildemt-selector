<!-- Defines element markup -->
<template id="mt-provider-letsmt-fields">
        <style>
        </style>
        <p class="required pull-left"><sup>*</sup> Required fields.</p>
        <br class="clear" />
        <span class="mt-error-key">Error message</span>
        <label for="new-engine-name">Engine name<sup>*</sup></label>
        <input class="required" id="new-engine-name" placeholder="here" />
        <div class="provider-data">
            <div class="provider-field">
                <label>Client ID<sup>*</sup></label>
                <input id="client_id_input" class="required" data-field-name="client_id" placeholder="here" />
            </div>
            <a href="https://readymt.tilde.com/Account/LoginApp?Client=matecat" target="_blank" class="clientid-link">Get my Client ID</a>
            <br class="clear" />
        </div>
		<button type="button" id="continue-button">Continue</button>
</template>

<template id="mt-provider-letsmt-config-fields">
        <style>
        </style>
        <p class="required pull-left"><sup>*</sup> Required fields.</p>
        <br class="clear" />
        <span class="mt-error-key">Error message</span>
        <input class="required hide" id="new-engine-name" placeholder="here" />
        <br class="clear" />
        <div class="provider-data">
            <div class="provider-field hide">
                <label>Client ID<sup>*</sup></label>
                <input class="required" data-field-name="client_id" placeholder="here" />
            </div>
            <div id="source_lang_field" class="pull-left">
                <label>From</label>
                <select><select/>
            </div>
            <div id="target_lang_field" class="pull-right">
                <label>To</label>
                <select><select/>
            </div>
            <div class="clear"></div>
            <div id="system_field" class="provider-field">
                <label>Translation system<sup>*</sup></label>
                <select id="system_select" class="required" data-field-name="system_id"></select>
            </div>
            <div id="filter_running_field">
                <label></label>
                <input type="checkbox" checked="checked"/>
                <label class="lighttext">Show running systems only</label>
            </div>
            <div class="provider-field">
                <label>Terms corpora</label>
                <select id="terms_id" class="required" data-field-name="terms_id"></select>
            </div>
            <div id="use_qe_field" class="provider-field pull-left">
                <label>QE beta</label>
                <input type="checkbox" data-field-name="use_qe"/>
                <a href="http://www.tilde.com/mt/tools/matecat" target="_blank"  class="info" title="You will see a translation only for segments with a QE (Quality Estimation) beta score above the selected figure."> </a>
            </div>
            <div id="minimum_qe_field" class="provider-field pull-right disabled">
                <label class="lighttext">Don't show translation if its QE score is below</label>
                <input type="number" step="0.01" min="0" max="1" value="0" data-field-name="minimum_qe" disabled="true"/>
            </div>
            <div class="provider-field hide">
                <input id="source-lang-id" data-field-name="source_lang" />
            </div>
            <div class="provider-field hide">
                <input id="target-lang-id" data-field-name="target_lang" />
            </div>
            <div class="clear"></div>
        </div>
		<button type="button" id="save_button">Save</button>
    </template>

<script>
(function(window, document, undefined) {
	// -------------Start ajax helper snippet----------------
	var ajax = {};
	ajax.x = function () {
		if (typeof XMLHttpRequest !== 'undefined') {
			return new XMLHttpRequest();
		}
		var versions = [
			"MSXML2.XmlHttp.6.0",
			"MSXML2.XmlHttp.5.0",
			"MSXML2.XmlHttp.4.0",
			"MSXML2.XmlHttp.3.0",
			"MSXML2.XmlHttp.2.0",
			"Microsoft.XmlHttp"
		];

		var xhr;
		for (var i = 0; i < versions.length; i++) {
			try {
				xhr = new ActiveXObject(versions[i]);
				break;
			} catch (e) {
			}
		}
		return xhr;
	};

	ajax.send = function (url, callback, method, data, async) {
		if (async === undefined) {
			async = true;
		}
		var x = ajax.x();
		x.open(method, url, async);
		x.onreadystatechange = function () {
			if (x.readyState == 4) {
				callback(x.responseText)
			}
		};
		if (method == 'POST') {
			x.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
		}
		x.send(data)
	};

	ajax.get = function (url, data, callback, async) {
		var query = [];
		for (var key in data) {
			query.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
		}
		ajax.send(url + (query.length ? '?' + query.join('&') : ''), callback, 'GET', null, async)
	};

	ajax.post = function (url, data, callback, async) {
		var query = [];
		for (var key in data) {
			query.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
		}
		ajax.send(url, callback, 'POST', query.join('&'), async)
	};
	// -------------End ajax helper snippet----------------


    // Refers to the "importer", which is index.html
    var thatDoc = document;
    // Refers to the "importee", which is src/hello-world.html
    var thisDoc =  (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;
    // Gets content from <template>
    var template = thisDoc.querySelector('template').content;
    // Creates an object based in the HTML Element prototype
    var MyElementProto = Object.create(HTMLElement.prototype);
    // Creates the "who" attribute and sets a default value
    MyElementProto.who = 'World';
	
	var ShadowRoot = null;
	var systemList = null;
	
	MyElementProto.showConfig = function(){
		var clientId = $(ShadowRoot).find("#client_id_input")[0].value;
		var data = {
			clientID: clientId,
		};
		var url = "https://letsmt.eu/ws/service.svc/json/GetSystemList";
		ajax.get(url, data, MyElementProto.handleResponse);
	};
	
	MyElementProto.handleResponse = function(resp) {
		var json = JSON.parse(resp);
		var statusNames = {
			 "running": "Running",
			 "queuingtransl": "Queuing",
			 "notstarted": "Not Started",
			 "nottrained": "Not Trained",
			 "error": "Not Trained",
			 "training": "Training",
			 "standby": "Standby",
		};
		systemList = json.System.map(function(elem){
			var statuses = elem.Metadata.filter(function(data){return data.Key == "status"});
			var status = statuses[0].Value;
			return {
				title: elem.Title.Text,
				id: elem.ID,
				sourceLanguageCode: elem.SourceLanguage.Code,
				targetLanguageCode: elem.TargetLanguage.Code,
				sourceLanguageName: elem.SourceLanguage.Name.Text,
				targetLanguageName: elem.TargetLanguage.Name.Text,
				status: status,
				statusName: status in statusNames ? statusNames[status] : status,
			}
		});
		MyElementProto.showNext(systemList);
	}
	
	MyElementProto.showNext = function(systemList){
		var template = thisDoc.querySelector('#mt-provider-letsmt-config-fields');
		var clone = thatDoc.importNode(template.content, true);
		ShadowRoot.appendChild(clone);
		MyElementProto.createFilters(systemList);
		ShadowRoot.getElementById("system_select").addEventListener("change", MyElementProto.fetchTerms);
		ShadowRoot.querySelector("#filter_running_field input").addEventListener("change", function(){MyElementProto.createFilters(systemList);});
		ShadowRoot.querySelector("#use_qe_field input").addEventListener("change", MyElementProto.toggleQEEnabled);
		ShadowRoot.getElementById("save_button").addEventListener("click", MyElementProto.fireSavedEvent);
	};
	
	// Feature detection for old Shadow DOM v0.
	// var USING_SHADOW_DOM_V0 = typeof HTMLElement.prototype.createShadowRoot !== 'undefined';
	
    // Fires when an instance of the element is created
    MyElementProto.createdCallback = function() {
        // Creates the shadow root
        ShadowRoot = this.createShadowRoot();
		var template = thisDoc.querySelector('#mt-provider-letsmt-fields');
		var clone = thatDoc.importNode(template.content, true);
        // Adds a template clone into shadow root
        //var clone = thatDoc.importNode(template, true);
        ShadowRoot.appendChild(clone);
		ShadowRoot.getElementById("continue-button").addEventListener("click", this.showConfig);
    };
    // Fires when an attribute was added, removed, or updated
    MyElementProto.attributeChangedCallback = function(attr, oldVal, newVal) {
    };
    // Fires when an instance was inserted into the document
    MyElementProto.attachedCallback = function() {};
    // Fires when an instance was removed from the document
    MyElementProto.detachedCallback = function() {};
	
	// The first template set this text to "Continue". Set it back now.
	$('#mt-provider-details #add-mt-provider-confirm .uploadkey').text('Confirm');
	// for some reason the javascript gets escaped without the CDATA tag. TODO: find out why
	MyElementProto.fetchTerms = function() {
		var termsFieldSelector = '#terms_id';
		$(ShadowRoot).find(termsFieldSelector).html("");
		
		var clientId = $(ShadowRoot).find("#client_id_input")[0].value;
		var systemId = $(ShadowRoot).find("#system_select")[0].value;
		var data = {
			clientID: clientId,
			systemID: systemId,
		};
		var url = "https://letsmt.eu/ws/service.svc/json/GetSystemTermCorpora";
		ajax.get(url, data, function(jsonString) {
				var termList = JSON.parse(jsonString);
				$(ShadowRoot).find(termsFieldSelector).append("<option value=''>--</option>");
				//$('#mt-provider-details .error').text("");
				termList.forEach(function(item){
					if(item.Status == "Ready"){
						$(ShadowRoot).find(termsFieldSelector).append("<option value='" + item.CorpusId + "'>" + item.Title + "</option>");
					}
				});
		});
	}
	MyElementProto.toggleQEEnabled = function() {
		var disabled = !this.checked;
		$(ShadowRoot).find('#minimum_qe_field input').prop('disabled', disabled);
		if (disabled) {
			$(ShadowRoot).find('#minimum_qe_field').addClass('disabled');
		} else {
			$(ShadowRoot).find('#minimum_qe_field').removeClass('disabled');
		}
	}
	MyElementProto.createFilters = function(systemList) {
		var sourceSelect = $(ShadowRoot).find('#source_lang_field select');
		var targetSelect = $(ShadowRoot).find('#target_lang_field select');
		var systemSelect = $(ShadowRoot).find('#system_field select');
		var sourceLangIdInput = $(ShadowRoot).find('#source-lang-id');
		var targetLangIdInput = $(ShadowRoot).find('#target-lang-id');
		var showOnlyRunningCheckbox = $(ShadowRoot).find('#filter_running_field input');
		var showOnlyRunning = showOnlyRunningCheckbox.prop('checked');
		var runningStatuses = { running: true, standby: true };
		sourceSelect.empty();
		// a mapping from available source languages to respective target languages
		var directions = [];
		systemList.forEach(function (elem){
			var systemStatus = elem.status;
			if(!(systemStatus in runningStatuses) && showOnlyRunning) {
				return;
			}
			var sourceCode = elem.sourceLanguageCode;
			var targetCode = elem.targetLanguageCode;
			var sourceName = elem.sourceLanguageName;
			var targetName = elem.targetLanguageName;
			if(!(sourceCode in directions)){
				directions[sourceCode] = {};
				directions[sourceCode].name = sourceName;
				directions[sourceCode].target = {};
			}
			directions[sourceCode].target[targetCode] = targetName;
		});
		var sortedSourceCodes = [];
		for (var sourceCode in directions) {
			sortedSourceCodes.push(sourceCode);
		}
		sortedSourceCodes.sort();
		for (var i=0; i<sortedSourceCodes.length; i++) {
			var sourceCode = sortedSourceCodes[i];
			var option = $('<option value="' + sourceCode + '">' + directions[sourceCode].name + '</option>');
			sourceSelect.append(option);
		}
		var filterSystems = function() {
			systemSelect.empty();
			var selectedSourceCode = sourceSelect.val();
			var selectedTargetCode = targetSelect.val();
			systemList.forEach(function (elem){
				var sourceCode = elem.sourceLanguageCode;
				var targetCode = elem.targetLanguageCode;
				var systemStatus = elem.status;
				if (sourceCode == selectedSourceCode
						&& targetCode == selectedTargetCode
						&&((systemStatus in runningStatuses) || !showOnlyRunning)) {
					var option = $('<option value="' + elem.id + '">' + elem.title + " (" + elem.status + ')</option>');
					systemSelect.append(option);
				}
			});
			var firstAvailableTargetCode = $(systemSelect.find('option').not(function() { return $(this).css("display") == "none" })[0]).val();
			systemSelect.val(firstAvailableTargetCode).change();
		}
		var fillTargetLanguages = function () {
			targetSelect.empty();
			var selectedSourceCode = sourceSelect.val();
			var targetChoices = directions[selectedSourceCode].target
			var sortedTargetCodes = [];
			for (var targetCode in targetChoices) {
				sortedTargetCodes.push(targetCode);
			}
			sortedTargetCodes.sort();
			for (var i=0; i<sortedTargetCodes.length; i++) {
				var targetCode = sortedTargetCodes[i];
				var option = $('<option value="' + targetCode + '">' + targetChoices[targetCode] + '</option>');
				targetSelect.append(option);
			}
			targetSelect.val(targetSelect.find("option:first").val()).change();
		}
		var setLanguageCodes = function () {
			var systemSourceCode = $("option:selected", this).data('source-language-code');
			var systemTargetCode = $("option:selected", this).data('target-language-code');
			sourceLangIdInput.val(systemSourceCode);
			targetLangIdInput.val(systemTargetCode);
		}
		// this method can get called multiple times. remove previously added event handlers
		sourceSelect.off('change');
		targetSelect.off('change');
		sourceSelect.change(fillTargetLanguages);
		targetSelect.change(filterSystems);
		systemSelect.change(setLanguageCodes);
		sourceSelect.val(sourceSelect.find("option:first").val()).change();
	}
	MyElementProto.renderMTConfigCallback = function() {
		createFilters();
	}
	
	MyElementProto.formatOptions = function(termsCorporaId, useQE, client, clientVersion){
		var options = [];
		// client and clientVersion are expected to be strings. hence the checks
		if (client && client.length && clientVersion && clientVersion.length)
		{
			options.push("client=" + client);
			options.push("version=" + clientVersion);
		}
		if (termsCorporaId){
			options.push("termCorpusId=" + termsCorporaId);
		};
		if (useQE){
			options.push("qe");
		}

		return options.join();
	};
	
	MyElementProto.getState = function() {
		var sourceSelect = $(ShadowRoot).find('#source_lang_field select');
		var targetSelect = $(ShadowRoot).find('#target_lang_field select');
		var selectedSourceCode = sourceSelect.val();
		var selectedTargetCode = targetSelect.val();
		var clientId = $(ShadowRoot).find("#client_id_input")[0].value;
		var systemId = $(ShadowRoot).find("#system_select")[0].value;
		var termsCorporaId = $(ShadowRoot).find('#terms_id')[0].value;
		var client = window.location.hostname;
		var version = "1.0";
		var useQE = $(ShadowRoot).find("#use_qe_field input").prop('checked');
		var retObj = {};
		retObj[selectedSourceCode + "-" + selectedTargetCode] = {
				//source: selectedSourceCode,
				//target: selectedTargetCode,
				clientID: clientId,
				systemID: systemId,
				options: MyElementProto.formatOptions(termsCorporaId, useQE, client, version),
		};
    return retObj;
	};
	
	MyElementProto.fireSavedEvent = function() {
		var state = MyElementProto.getState(); 	
		// create custom event instance
		var event = new CustomEvent("save", {detail: state});
		// dispatch event
		this.dispatchEvent(event);
	};
	
    // Registers <tildemt-selector> in the main document
    window.MyElement = thatDoc.registerElement('tildemt-selector', {
        prototype: MyElementProto
    });
})(window, document);
</script>
