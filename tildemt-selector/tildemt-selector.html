<!-- Defines element markup -->
<template id="letsmt_initial_template">
        <style>
		 .error {
			 color: red;
		 }
		 .table {
			 display: table;
		 }
		 .row {
			 display: table-row;
		 }
		 .cell {
			 display: table-cell;
			 padding-bottom: 1em;
		 }
		 .clientid-link {
			 display: block;
		 }
		 .fill {
			 width: 100%;
		 }
		 .row label, label.cell {
			 padding-right: 1em;
			 white-space: nowrap;
		 }
		 .cell.pad-right {
			 padding-right: 1em;
		 }
		 .cell.pad-left {
			 padding-left: 1em;
		 }
		 /* .row label .wrap { */
		 /* white-space: wrap; */
		 /* } */
		 input, select {
			 height: 2em;
		 }
		 button {
			 padding: 0.3em 0.6em;
		 }
		 .table input[type="checkbox"] {
			 width: 1.3em;
			 height: 1.3em;
		 }
        </style>
        <!-- <p class="required pull-left"><sup>*</sup> Required fields.</p> -->
		<div class="table">
			<div class="error" id="error_message"></div>
			<div class="row">
				<label class="cell" for="engine_name">Engine name<sup>*</sup></label>
				<div class="cell fill">
					<input class="required fill" id="engine_name" placeholder="Name your engine" />
				</div>
			</div>
			<div class="row">
				<label class="cell" for="client_id_input">Client ID<sup>*</sup></label>
				<div class="cell fill">
					<input class="fill" id="client_id_input" class="required" placeholder="Click 'Get my Client ID'" />
					<a href="https://readymt.tilde.com/Account/LoginApp?Client=matecat" target="_blank" class="clientid-link">Get my Client ID</a>
				</div>
			</div>
			<button type="button" id="continue_button">Continue</button>
		</div>
</template>

<template id="letsmt_selection_template">
        <style>
        </style>
        <!-- <p class="required pull-left"><sup>*</sup> Required fields.</p> -->
		<!-- Decided to support IE10, hence the nested table madness instead of flexboxes. -->
        <div class="table fill">
			<div class="row error" id="error_message"></div>
			<div class="table fill">
				<div class="cell pad-right" id="source_lang_field" class="pull-left">
					<div class="table fill">
						<label class="cell" for="source_select">From</label>
						<div class="cell fill">
							<select class="fill" id="source_select"></select>
						</div>
					</div>
				</div>
				<div class="cell pad-left" id="target_lang_field" class="pull-right">
					<div class="table fill">
						<label class="cell" for="target_select">To</label>
						<div class="cell fill">
							<select class="fill" id="target_select"></select>
						</div>
					</div>
				</div>
			</div>
			<div class="table fill">
				<div class="row" id="system_field" >
					<label class="cell">Translation system<sup>*</sup></label>
					<div class="cell fill">
						<select id="system_select" class="required fill"></select>
						<div id="filter_running_field">
							<input type="checkbox" checked="checked"/>
							<label class="lighttext">Show running systems only</label>
						</div>
					</div>
				</div>
				<div class="row">
					<label class="cell">Terms corpora</label>
					<div class="cell fill">
						<select class="required fill" id="terms_id"></select>
					</div>
				</div>
				<div class="row">
					<div class="cell" id="use_qe_field" class="provider-field pull-left">
						<label>QE beta</label>
						<input type="checkbox"/>
						<!-- <a href="http://www.tilde.com/mt/tools/matecat" target="_blank"  class="info" title="You will see a translation only for segments with a QE (Quality Estimation) beta score above the selected figure."> </a> -->
					</div>
					<div class="cell" id="minimum_qe_field" class="provider-field pull-right disabled">
						<label class="wrap" class="lighttext">Don't show translation if its QE score is below</label>
						<input class="" type="number" step="0.01" min="0" max="1" value="0" disabled="true"/>
					</div>
				</div>
			</div>
			<button class="row" type="button" id="save_button">Save</button>
        </div>
    </template>

<script>
(function(window, document, undefined) {
	// -------------Start ajax helper snippet----------------
	var ajax = {};
	ajax.x = function () {
		if (typeof XMLHttpRequest !== 'undefined') {
			return new XMLHttpRequest();
		}
		var versions = [
			"MSXML2.XmlHttp.6.0",
			"MSXML2.XmlHttp.5.0",
			"MSXML2.XmlHttp.4.0",
			"MSXML2.XmlHttp.3.0",
			"MSXML2.XmlHttp.2.0",
			"Microsoft.XmlHttp"
		];

		var xhr;
		for (var i = 0; i < versions.length; i++) {
			try {
				xhr = new ActiveXObject(versions[i]);
				break;
			} catch (e) {
			}
		}
		return xhr;
	};

	ajax.send = function (url, callback, method, data, customHeaders, async) {
		if (async === undefined) {
			async = true;
		}
		var x = ajax.x();
		x.open(method, url, async);
		x.onreadystatechange = function () {
			if (x.readyState == 4) {
				callback(x.responseText)
			}
		};
		if (method == 'POST') {
			x.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
		}
		if (customHeaders) {
			var keys = Object.keys(customHeaders);
			keys.forEach(function(key){
				x.setRequestHeader(key, customHeaders[key]);
			});
		};
		x.send(data);
	};

	ajax.get = function (url, data, callback, customHeaders, async) {
		var query = [];
		for (var key in data) {
			query.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
		}
		ajax.send(url + (query.length ? '?' + query.join('&') : ''), callback, 'GET', null, customHeaders, async)
	};

	ajax.post = function (url, data, callback, customHeaders, async) {
		var query = [];
		for (var key in data) {
			query.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
		}
		ajax.send(url, callback, 'POST', query.join('&'), customHeaders, async)
	};
	// -------------End ajax helper snippet----------------


    // Refers to the "importer", which is index.html
    var thatDoc = document;
    // Refers to the "importee", which is src/hello-world.html
    var thisDoc =  (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;
    // Gets content from <template>
    var template = thisDoc.querySelector('template').content;
    // Creates an object based in the HTML Element prototype
    var MyElementProto = Object.create(HTMLElement.prototype);
    // Creates the "who" attribute and sets a default value
	

	 MyElementProto.getActiveSource = function() {
		var sourceSelect = $(this.ShadowRoot).find('#source_lang_field select');
		var selectedSourceCode = sourceSelect.val();
		return selectedSourceCode;
	 }

	 MyElementProto.setActiveSource = function(value) {
		var sourceSelect = $(this.ShadowRoot).find('#source_lang_field select');
		sourceSelect.val(value);
	 }

	 MyElementProto.getActiveTarget = function() {
		var targetSelect = $(this.ShadowRoot).find('#target_lang_field select');
		var selectedTargetCode = targetSelect.val();
		return selectedTargetCode;
	 }

	 MyElementProto.setActiveTarget = function(value) {
		var targetSelect = $(this.ShadowRoot).find('#target_lang_field select');
		targetSelect.val(value);
	 }

	 MyElementProto.getActiveLanguage = function(){
		var sourceSelect = $(this.ShadowRoot).find('#source_lang_field select');
		var targetSelect = $(this.ShadowRoot).find('#target_lang_field select');
		var selectedSourceCode = sourceSelect.val();
		var selectedTargetCode = targetSelect.val();
		return {source: selectedSourceCode, target: selectedTargetCode};
	 }

	 MyElementProto.setActiveLanguage = function(source, target){
		var sourceSelect = $(this.ShadowRoot).find('#source_lang_field select');
		var targetSelect = $(this.ShadowRoot).find('#target_lang_field select');
		sourceSelect.value = source;
		targetSelect.value = target;
	 };

	 MyElementProto.getActiveSystem = function(){
		var systemId = $(this.ShadowRoot).find("#system_select")[0].value;
		return systemId;
	 };

	 MyElementProto.setActiveSystem = function(value){
		$(this.ShadowRoot).find("#system_select").val(value);
	 };

	 MyElementProto.getActiveUseQe = function(){
		var useQe = $(this.ShadowRoot).find("#use_qe_field input").prop('checked');
		return useQe;
	 };

	 MyElementProto.setActiveUseQe = function(value){
		$(this.ShadowRoot).find("#use_qe_field input").prop('checked', value);
	 };

	 MyElementProto.getActiveTerms = function(){
		var termsCorporaId = $(this.ShadowRoot).find('#terms_id')[0].value;
		return termsCorporaId;
	 };

	 MyElementProto.setActiveTerms = function(value){
		$(this.ShadowRoot).find('#terms_id').val(value);
	 };

	 MyElementProto._formatLanguageKey = function(source, target){
		 return source + "-" + target;
	 }

	 MyElementProto.getSystem = function(source, target){
		 var key = this._formatLanguageKey(source, target);
		 if (key in this.systems) {
			 return this.systems[key];
		 }
		 return undefined;
	 };

	 MyElementProto.setSystem = function(source, target, systemId, termsId, useQe){
		 var key = this._formatLanguageKey(source, target);
		 this.systems[key] = {"systemId": systemId, "termsId": termsId, "useQe": useQe};
		 // TODO: update the GUI
	 };

	 MyElementProto.setTermList = function(termList){
		var termsFieldSelector = '#terms_id';
		$(this.ShadowRoot).find(termsFieldSelector).html("");
		var termsSelect = $(this.ShadowRoot).find(termsFieldSelector);
		termsSelect.append("<option value=''>--</option>");
		//$('#mt-provider-details .error').text("");
		termList.forEach(function(item){
			if(item.Status == "Ready"){
				termsSelect.append("<option value='" + item.CorpusId + "'>" + item.Title + "</option>");
			}
		});
	 }

	 MyElementProto.getClientId = function(){
		 return $(this.ShadowRoot).find("#client_id_input")[0].value;
	 }
	
	MyElementProto.showConfig = function(){
		var clientId = this.getClientId();
		var headers = {
			"client-id": clientId,
		};
		var url = "https://letsmt.eu/ws/service.svc/json/GetSystemList";
		ajax.get(url, undefined, this.handleResponse.bind(this), headers);
	};
	
	MyElementProto.handleResponse = function(resp) {
		var json = JSON.parse(resp);
		var statusNames = {
			 "running": "Running",
			 "queuingtransl": "Queuing",
			 "notstarted": "Not Started",
			 "nottrained": "Not Trained",
			 "error": "Not Trained",
			 "training": "Training",
			 "standby": "Standby",
		};
		this.systemList = json.System.map(function(elem){
			var statuses = elem.Metadata.filter(function(data){return data.Key == "status"});
			var status = statuses[0].Value;
			return {
				title: elem.Title.Text,
				id: elem.ID,
				sourceLanguageCode: elem.SourceLanguage.Code,
				targetLanguageCode: elem.TargetLanguage.Code,
				sourceLanguageName: elem.SourceLanguage.Name.Text,
				targetLanguageName: elem.TargetLanguage.Name.Text,
				status: status,
				statusName: status in statusNames ? statusNames[status] : status,
			}
		});
		this.showNext(this.systemList);
	}
	
	MyElementProto.showNext = function(systemList){
		var template = thisDoc.querySelector('#letsmt_selection_template');
		var clone = thatDoc.importNode(template.content, true);
		this.ShadowRoot.appendChild(clone);
		this.createFilters(systemList);
		this.ShadowRoot.getElementById("system_select").addEventListener("change", this.fetchTerms.bind(this));
		this.ShadowRoot.querySelector("#filter_running_field input")
				  .addEventListener(
					  "change",
					  function(){this.createFilters(systemList);}.bind(this)
				  );
		this.ShadowRoot.querySelector("#use_qe_field input")
				  .addEventListener("change", this.toggleQEEnabled.bind(this));
		this.ShadowRoot.getElementById("save_button")
				  .addEventListener("click", this.fireSavedEvent.bind(this));
	};
	
	// Feature detection for old Shadow DOM v0.
	// var USING_SHADOW_DOM_V0 = typeof HTMLElement.prototype.createShadowRoot !== 'undefined';
	
    // Fires when an instance of the element is created
    MyElementProto.createdCallback = function() {
        // Creates the shadow root
        this.systemList = null;
        this.ShadowRoot = this.createShadowRoot();
        var template = thisDoc.querySelector('#letsmt_initial_template');
        var clone = thatDoc.importNode(template.content, true);
        // Adds a template clone into shadow root
        //var clone = thatDoc.importNode(template, true);
        this.ShadowRoot.appendChild(clone);
        this.ShadowRoot.getElementById("continue_button").addEventListener("click", this.showConfig.bind(this));
    };
    // Fires when an attribute was added, removed, or updated
    MyElementProto.attributeChangedCallback = function(attr, oldVal, newVal) {
    };
    // Fires when an instance was inserted into the document
    MyElementProto.attachedCallback = function() {};
    // Fires when an instance was removed from the document
    MyElementProto.detachedCallback = function() {};
	
	MyElementProto.fetchTerms = function() {
		
		var clientId = this.getClientId();
		var systemId = this.getActiveSystem();
		var data = {
			systemID: systemId,
		};
		var headers = {
			"client-id": clientId,
		};
		var url = "https://letsmt.eu/ws/service.svc/json/GetSystemTermCorpora";
		ajax.get(url, data, function(jsonString) {
					var termList = JSON.parse(jsonString);
					this.setTermList(termList);
				}.bind(this), headers);
	}
	MyElementProto.toggleQEEnabled = function() {
		var disabled = !this.checked;
		$(this.ShadowRoot).find('#minimum_qe_field input').prop('disabled', disabled);
		if (disabled) {
			$(this.ShadowRoot).find('#minimum_qe_field').addClass('disabled');
		} else {
			$(this.ShadowRoot).find('#minimum_qe_field').removeClass('disabled');
		}
	}

	 MyElementProto._runningStatuses = { running: true, standby: true };

	 MyElementProto._buildDirections = function(systemList, showOnlyRunning){
		var directions = [];
		systemList.forEach(function (elem){
			var systemStatus = elem.status;
			if(!(systemStatus in this._runningStatuses) && showOnlyRunning) {
				return;
			}
			var sourceCode = elem.sourceLanguageCode;
			var targetCode = elem.targetLanguageCode;
			var sourceName = elem.sourceLanguageName;
			var targetName = elem.targetLanguageName;
			if(!(sourceCode in directions)){
				directions[sourceCode] = {};
				directions[sourceCode].name = sourceName;
				directions[sourceCode].target = {};
			}
			directions[sourceCode].target[targetCode] = targetName;
		}.bind(this));
		return directions;
	 }

	 MyElementProto._fillSourceLangs = function(directions){
		var sourceSelect = $(this.ShadowRoot).find('#source_lang_field select');
		sourceSelect.empty();
		var sortedSourceCodes = [];
		for (var sourceCode in directions) {
			sortedSourceCodes.push(sourceCode);
		}
		sortedSourceCodes.sort();
		for (var i=0; i<sortedSourceCodes.length; i++) {
			var sourceCode = sortedSourceCodes[i];
			var option = $('<option value="' + sourceCode + '">' + directions[sourceCode].name + '</option>');
			sourceSelect.append(option);
		}
	 }

	 MyElementProto._filterSystems = function(showOnlyRunning){
		var systemSelect = $(this.ShadowRoot).find('#system_field select');
		systemSelect.empty();
		var selectedSourceCode = this.getActiveSource();
		var selectedTargetCode = this.getActiveTarget();
		this.systemList.forEach(function (elem){
			var sourceCode = elem.sourceLanguageCode;
			var targetCode = elem.targetLanguageCode;
			var systemStatus = elem.status;
			if (sourceCode == selectedSourceCode
					&& targetCode == selectedTargetCode
					&&((systemStatus in this._runningStatuses) || !showOnlyRunning)) {
				var option = $('<option value="' + elem.id + '">' + elem.title + " (" + elem.status + ')</option>');
				systemSelect.append(option);
			}
		}.bind(this));
		var firstAvailableTargetCode = $(systemSelect.find('option').not(function() {
				return $(this).css("display") == "none";
			})[0]).val();
		systemSelect.val(firstAvailableTargetCode).change();
	 }

	MyElementProto._fillTargetLanguages = function (directions) {
		var targetSelect = $(this.ShadowRoot).find('#target_lang_field select');
		targetSelect.empty();
		var selectedSourceCode = this.getActiveSource();
		var targetChoices = directions[selectedSourceCode].target;
		var sortedTargetCodes = [];
		for (var targetCode in targetChoices) {
			sortedTargetCodes.push(targetCode);
		}
		sortedTargetCodes.sort();
		for (var i=0; i<sortedTargetCodes.length; i++) {
			var targetCode = sortedTargetCodes[i];
			var option = $('<option value="' + targetCode + '">' + targetChoices[targetCode] + '</option>');
			targetSelect.append(option);
		}
		targetSelect.val(targetSelect.find("option:first").val()).change();
	}

	MyElementProto.createFilters = function(systemList) {
		var sourceSelect = $(this.ShadowRoot).find('#source_lang_field select');
		var targetSelect = $(this.ShadowRoot).find('#target_lang_field select');
		var systemSelect = $(this.ShadowRoot).find('#system_field select');
		var showOnlyRunningCheckbox = $(this.ShadowRoot).find('#filter_running_field input');
		var showOnlyRunning = showOnlyRunningCheckbox.prop('checked');
		// a mapping from available source languages to respective target languages
		var directions = this._buildDirections(systemList, showOnlyRunning);
		this._fillSourceLangs(directions);
		this._fillTargetLanguages(directions);
		// this method can get called multiple times. remove previously added event handlers
		sourceSelect.off('change');
		targetSelect.off('change');
		sourceSelect.change(function(){this._fillTargetLanguages(directions);}.bind(this));
		targetSelect.change(function(){this._filterSystems(showOnlyRunning);}.bind(this));
		sourceSelect.val(sourceSelect.find("option:first").val()).change();
	}
	MyElementProto.renderMTConfigCallback = function() {
		createFilters();
	}
	
	MyElementProto.formatOptions = function(termsCorporaId, useQE, client, clientVersion){
		var options = [];
		// client and clientVersion are expected to be strings. hence the checks
		if (client && client.length && clientVersion && clientVersion.length)
		{
			options.push("client=" + client);
			options.push("version=" + clientVersion);
		}
		if (termsCorporaId){
			options.push("termCorpusId=" + termsCorporaId);
		};
		if (useQE){
			options.push("qe");
		}

		return options.join();
	};

	 MyElementProto.getClient = function(){
		 return window.location.hostname;
	 };

	 MyElementProto.getVersion = function() {
		 return "1.0";
	 };
	
	MyElementProto.getState = function() {
		var engineName = $(this.ShadowRoot).find('#engine_name').val();
		var selectedSourceCode = this.getActiveSource();
		var selectedTargetCode = this.getActiveTarget();
		var clientId = this.getClientId();
		var systemId = this.getActiveSystem();
		var termsCorporaId = this.getActiveTerms();
		var client = this.getClient();
		var version = this.getVersion();
		var useQE = this.getActiveUseQe();
		var systemConfig = {};
		systemConfig[selectedSourceCode + "-" + selectedTargetCode] = {
				systemID: systemId,
				options: this.formatOptions(termsCorporaId, useQE, client, version),
		};
		var state = {
			"engineName": engineName,
			"client-id": clientId,
			"systems": systemConfig,
		}
    return state;
	};

	 MyElementProto.setState = function(state) {
		var sourceSelect = this.ShadowRoot.querySelector('#source_lang_field select');
		var targetSelect = this.ShadowRoot.querySelector('#target_lang_field select');
		var engineName = this.ShadowRoot.querySelector('#engine_name').value;
		var sourceTargetLangs = Object.keys(state.systems);
		var langs = sourceTargetLangs.split("-");
		sourceSelect.value = langs[0];
		targetSelect.value = target[1];
		this.ShadowRoot.querySelector("#client_id_input").value = state['client-id'];
		this.ShadowRoot.querySelector("#system_select").value = state.systems[sourceTargetLangs].systemID;
		var termsCorporaId = this.ShadowRoot.querySelector('#terms_id')[0].value;
		var client = window.location.hostname;
		var version = "1.0";
		var useQE = this.ShadowRoot.querySelector("#use_qe_field input").prop('checked');
		var systemConfig = {};
		systemConfig[selectedSourceCode + "-" + selectedTargetCode] = {
				systemID: systemId,
				options: this.formatOptions(termsCorporaId, useQE, client, version),
		};
		var state = {
			"engineName": engineName,
			"client-id": clientId,
			"systems": systemConfig,
		}
    return state;
	};
	
	MyElementProto.fireSavedEvent = function() {
		var state = this.getState(); 	
		// create custom event instance
		var event = new CustomEvent("save", {detail: state});
		// dispatch event
		this.dispatchEvent(event);
	};
	
    // Registers <tildemt-selector> in the main document
    window.MyElement = thatDoc.registerElement('tildemt-selector', {
        prototype: MyElementProto
    });
})(window, document);
</script>
