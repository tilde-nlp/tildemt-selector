<!-- Defines element markup -->
<template id="mt-provider-letsmt-fields">
        <style>
            .clientid-link {
                float: right;
                margin-top: -10px;
            }
        </style>
        <p class="required pull-left"><sup>*</sup> Required fields.</p>
        <br class="clear" />
        <span class="mt-error-key">Error message</span>
        <label for="new-engine-name">Engine name<sup>*</sup></label>
        <input class="required" id="new-engine-name" placeholder="here" />
        <div class="provider-data">
            <div class="provider-field">
                <label>Client ID<sup>*</sup></label>
                <input class="required" data-field-name="client_id" placeholder="here" />
            </div>
            <a href="https://readymt.tilde.com/Account/LoginApp?Client=matecat" target="_blank" class="clientid-link">Get my Client ID</a>
            <br class="clear" />
        </div>
		<button type="button" id="continue-button">Continue</button>
</template>

<template id="mt-provider-letsmt-config-fields">
        <script>
            <![CDATA[
            // The first template set this text to "Continue". Set it back now.
            $('#mt-provider-details #add-mt-provider-confirm .uploadkey').text('Confirm');
            // for some reason the javascript gets escaped without the CDATA tag. TODO: find out why
            function fetchTerms() {
                var termsFieldSelector = '.insert-tm .provider-data .provider-field [data-field-name="terms_id"]';
                $(termsFieldSelector).html("");
                var providerData = {};
                $('.insert-tm .provider-data .provider-field').each(function () {
                    var field = $(this).find('input, select').first();
                    if (field.prop('type') === 'checkbox') {
                        providerData[field.attr('data-field-name')] = field.prop('checked');
                    } else {
                        providerData[field.attr('data-field-name')] = field.val();
                    }
                });
                if (!providerData['system_id']) {
                    return;
                }
                providerData['function'] = 'getTermList';
                var provider = 'letsmt';
                var name = 'temp engine';
                var providerName = 'Tilde MT';
                data = {
                    action: 'engine',
                    exec: 'execute',
                    name: name,
                    provider: provider,
                    data: JSON.stringify(providerData)
                };
                context = data;
                context.providerName = providerName;
                APP.doRequest({
                    data: data,
                    context: context,
                    error: function() {
                        console.log('error');
                    },
                    success: function(d) {
                        console.log('AJAX response received.');
                        if(d.errors.length) {
                            console.log('error');
                            $('#mt-provider-details .error').text(d.errors[0].message);
                        } else {
                            $('#mt-provider-details .error').text("");
                            if(d.data.result && d.data.result.terms && Object.keys(d.data.result.terms).length) {
                                $(termsFieldSelector).append("<option value=''>--</option>");
                                $terms = d.data.result.terms;
                                console.log('success');
                                for (var key in $terms){
                                    $(termsFieldSelector).append("<option value='" + key + "'>" + $terms[key] + "</option>");
                                }
                            }
                        }
                    }
                });
            }
            function toggleQEEnabled(checkbox) {
                var disabled = !checkbox.checked;
                $('#minimum_qe_field input').prop('disabled', disabled);
                if (disabled) {
                    $('#minimum_qe_field').addClass('disabled');
                } else {
                    $('#minimum_qe_field').removeClass('disabled');
                }
            }
            function createFilters() {
                var sourceSelect = $('#source_lang_field select');
                var targetSelect = $('#target_lang_field select');
                var systemSelect = $('#system_field select');
                var systemOptions = $('#system_field select option');
                var sourceLangIdInput = $('#source-lang-id');
                var targetLangIdInput = $('#target-lang-id');
                var showOnlyRunningCheckbox = $('#filter_running_field input');
                var showOnlyRunning = showOnlyRunningCheckbox.prop('checked');
                var runningStatuses = { running: true, standby: true };
                sourceSelect.empty();
                // a mapping from available source languages to respective target languages
                var directions = [];
                systemOptions.each(function (){
                    var systemStatus = $(this).data('status');
                    if(!(systemStatus in runningStatuses) && showOnlyRunning) {
                        return;
                    }
                    var sourceCode = $(this).data('source-language-code');
                    var targetCode = $(this).data('target-language-code');
                    var sourceName = $(this).data('source-language-name');
                    var targetName = $(this).data('target-language-name');
                    if(!(sourceCode in directions)){
                        directions[sourceCode] = {};
                        directions[sourceCode].name = sourceName;
                        directions[sourceCode].target = {};
                    }
                    directions[sourceCode].target[targetCode] = targetName;
                });
                var sortedSourceCodes = [];
                for (var sourceCode in directions) {
                    sortedSourceCodes.push(sourceCode);
                }
                sortedSourceCodes.sort();
                for (var i=0; i<sortedSourceCodes.length; i++) {
                    var sourceCode = sortedSourceCodes[i];
                    var option = $('<option value="' + sourceCode + '">' + directions[sourceCode].name + '</option>');
                    sourceSelect.append(option);
                }
                var filterSystems = function() {
                    var selectedSourceCode = sourceSelect.val();
                    var selectedTargetCode = targetSelect.val();
                    systemOptions.each(function () {
                        var systemSourceCode = $(this).data('source-language-code');
                        var systemTargetCode = $(this).data('target-language-code');
                        var systemStatus = $(this).data('status');
                        if (systemSourceCode == selectedSourceCode
                                && systemTargetCode == selectedTargetCode
                                &&((systemStatus in runningStatuses) || !showOnlyRunning)) {
                            $(this).show();
                        } else {
                            $(this).hide();
                        }
                    });
                    var firstAvailableTargetCode = $(systemSelect.find('option').not(function() { return $(this).css("display") == "none" })[0]).val();
                    systemSelect.val(firstAvailableTargetCode).change();
                }
                var fillTargetLanguages = function () {
                    targetSelect.empty();
                    var selectedSourceCode = sourceSelect.val();
                    var targetChoices = directions[selectedSourceCode].target
                    var sortedTargetCodes = [];
                    for (var targetCode in targetChoices) {
                        sortedTargetCodes.push(targetCode);
                    }
                    sortedTargetCodes.sort();
                    for (var i=0; i<sortedTargetCodes.length; i++) {
                        var targetCode = sortedTargetCodes[i];
                        var option = $('<option value="' + targetCode + '">' + targetChoices[targetCode] + '</option>');
                        targetSelect.append(option);
                    }
                    targetSelect.val(targetSelect.find("option:first").val()).change();
                }
                var setLanguageCodes = function () {
                    var systemSourceCode = $("option:selected", this).data('source-language-code');
                    var systemTargetCode = $("option:selected", this).data('target-language-code');
                    sourceLangIdInput.val(systemSourceCode);
                    targetLangIdInput.val(systemTargetCode);
                }
                // this method can get called multiple times. remove previously added event handlers
                sourceSelect.off('change');
                targetSelect.off('change');
                sourceSelect.change(fillTargetLanguages);
                targetSelect.change(filterSystems);
                systemSelect.change(setLanguageCodes);
                sourceSelect.val(sourceSelect.find("option:first").val()).change();
            }
            function renderMTConfigCallback () {
                createFilters();
            }
            ]]>
        </script>
        <style>
            .insert-tm select {
                width: 324px!important;
            }
            .insert-tm input[type="number"] {
                width: 50px!important;
            }
            #source_lang_field select, #target_lang_field select {
                width: 130px!important;
            }
            #target_lang_field label {
                width: 40px!important;
            }
            .clear {
                clear: both;
            }
            #filter_running_field {
                margin-top: -10px!important;
                height: 40px!important;
            }
            #filter_running_field label:last-of-type {
                width: 273px!important;
                text-align: left!important;
                margin-left: 10px!important;
                /* font-weight: normal!important; */
                position: relative!important;
                top: -10px!important;
            }
            .lighttext {
                font-size: small!important;
                color: #999!important;
                font-weight: normal!important;
            }
            .info{
                background: url(../../public/img/info.png) no-repeat center;
                background-size: 24px 24px;
                display: inline-block;
                width: 22px;
                height: 22px;
                margin: 0;
            }
        </style>
        <p class="required pull-left"><sup>*</sup> Required fields.</p>
        <br class="clear" />
        <span class="mt-error-key">Error message</span>
        <input class="required hide" id="new-engine-name" placeholder="here" />
        <br class="clear" />
        <div class="provider-data">
            <div class="provider-field hide">
                <label>Client ID<sup>*</sup></label>
                <input class="required" data-field-name="client_id" placeholder="here" />
            </div>
            <div id="source_lang_field" class="pull-left">
                <label>From</label>
                <select/>
            </div>
            <div id="target_lang_field" class="pull-right">
                <label>To</label>
                <select/>
            </div>
            <div class="clear"></div>
            <div id="system_field" class="provider-field">
                <label>Translation system<sup>*</sup></label>
                <select class="required" data-field-name="system_id" onchange="fetchTerms()"/>
            </div>
            <div id="filter_running_field">
                <label></label>
                <input type="checkbox" checked="checked" onchange="createFilters()"/>
                <label class="lighttext">Show running systems only</label>
            </div>
            <div class="provider-field">
                <label>Terms corpora</label>
                <select class="required" data-field-name="terms_id" />
            </div>
            <div id="use_qe_field" class="provider-field pull-left">
                <label>QE beta</label>
                <input type="checkbox" data-field-name="use_qe" onchange="toggleQEEnabled(this)" />
                <a href="http://www.tilde.com/mt/tools/matecat" target="_blank"  class="info" title="You will see a translation only for segments with a QE (Quality Estimation) beta score above the selected figure."> </a>
            </div>
            <div id="minimum_qe_field" class="provider-field pull-right disabled">
                <label class="lighttext">Don't show translation if its QE score is below</label>
                <input type="number" step="0.01" min="0" max="1" value="0" data-field-name="minimum_qe" disabled="true"/>
            </div>
            <div class="provider-field hide">
                <input id="source-lang-id" data-field-name="source_lang" />
            </div>
            <div class="provider-field hide">
                <input id="target-lang-id" data-field-name="target_lang" />
            </div>
            <div class="clear"></div>
        </div>
    </template>

<script>
(function(window, document, undefined) {
    // Refers to the "importer", which is index.html
    var thatDoc = document;
    // Refers to the "importee", which is src/hello-world.html
    var thisDoc =  (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;
    // Gets content from <template>
    var template = thisDoc.querySelector('template').content;
    // Creates an object based in the HTML Element prototype
    var MyElementProto = Object.create(HTMLElement.prototype);
    // Creates the "who" attribute and sets a default value
    MyElementProto.who = 'World';
	
	var ShadowRoot = null;
	
	MyElementProto.showNext = function(){
		var template = thisDoc.querySelector('#mt-provider-letsmt-config-fields');
		var clone = thatDoc.importNode(template.content, true);
		// Adds a template clone into shadow root
		//var clone = document.importNode(template, true);
		ShadowRoot.appendChild(clone);
	};
	
	// Feature detection for old Shadow DOM v0.
	// var USING_SHADOW_DOM_V0 = typeof HTMLElement.prototype.createShadowRoot !== 'undefined';
	
    // Fires when an instance of the element is created
    MyElementProto.createdCallback = function() {
        // Creates the shadow root
        ShadowRoot = this.createShadowRoot();
		var template = thisDoc.querySelector('#mt-provider-letsmt-fields');
		var clone = thatDoc.importNode(template.content, true);
        // Adds a template clone into shadow root
        //var clone = thatDoc.importNode(template, true);
        ShadowRoot.appendChild(clone);
		ShadowRoot.getElementById("continue-button").addEventListener("click", this.showNext);
    };
    // Fires when an attribute was added, removed, or updated
    MyElementProto.attributeChangedCallback = function(attr, oldVal, newVal) {
    };
    // Fires when an instance was inserted into the document
    MyElementProto.attachedCallback = function() {};
    // Fires when an instance was removed from the document
    MyElementProto.detachedCallback = function() {};
	
    // Registers <tildemt-selector> in the main document
    window.MyElement = thatDoc.registerElement('tildemt-selector', {
        prototype: MyElementProto
    });
})(window, document);
</script>