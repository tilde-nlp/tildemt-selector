<!-- Defines element markup -->
<template id="letsmt_initial_template">
    <style>
     .error {
         color: red;
     }
     .table {
         display: table;
     }
     .row {
         display: table-row;
     }
     .cell {
         display: table-cell;
         padding-bottom: 1em;
     }
     .clientid-link {
         display: block;
     }
     .fill {
         width: 100%;
     }
     .row label, label.cell {
         padding-right: 1em;
         white-space: nowrap;
     }
     .cell.pad-right {
         padding-right: 1em;
     }
     .cell.pad-left {
         padding-left: 1em;
     }
     /* .row label .wrap { */
     /* white-space: wrap; */
     /* } */
     input, select {
         height: 2em;
     }
     button {
         padding: 0.3em 0.6em;
     }
     .table input[type="checkbox"] {
         width: 1.3em;
         height: 1.3em;
     }
     .ok-button, .cancel-button {
         display:inline-block;
     }

     .link-button {
        background:none!important;
        border:none; 
        padding:0!important;
        font: inherit;
        /*border is optional*/
        border-bottom:1px solid #444; 
        cursor: pointer;
     }

     #logout_container {
         text-align: right;
         margin-bottom: 1em;
     }

    .help-tip{
        position: absolute;
        top: 18px;
        right: 18px;
        text-align: center;
        background-color: #BCDBEA;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 14px;
        line-height: 26px;
        cursor: default;
    }

    .help-tip:before{
        content:'?';
        font-weight: bold;
        color:#fff;
    }

    .help-tip:hover p{
        display:block;
        transform-origin: 100% 0%;

        -webkit-animation: fadeIn 0.3s ease-in-out;
        animation: fadeIn 0.3s ease-in-out;

    }

    .help-tip p{	/* The tooltip */
        display: none;
        text-align: left;
        background-color: #1E2021;
        padding: 20px;
        width: 300px;
        position: absolute;
        border-radius: 3px;
        box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
        right: -4px;
        color: #FFF;
        font-size: 13px;
        line-height: 1.4;
    }

    .help-tip p:before{ /* The pointer of the tooltip */
        position: absolute;
        content: '';
        width:0;
        height: 0;
        border:6px solid transparent;
        border-bottom-color:#1E2021;
        right:10px;
        top:-12px;
    }

    .help-tip p:after{ /* Prevents the tooltip from being hidden */
        width:100%;
        height:40px;
        content:'';
        position: absolute;
        top:-40px;
        left:0;
    }

        /* CSS animation */

    @-webkit-keyframes fadeIn {
        0% { 
            opacity:0; 
            transform: scale(0.6);
        }

        100% {
            opacity:100%;
            transform: scale(1);
        }
    }

    @keyframes fadeIn {
        0% { opacity:0; }
        100% { opacity:100%; }
    }
    </style>
    <!-- <p class="required pull-left"><sup>*</sup> Required fields.</p> -->
    <form id="initial_config" action="">
        <div class="table">
            <div class="error" id="error_message"></div>
            <div class="row">
                <!-- <div class="cell"> -->
                    <label class="cell" for="engine_name">Engine name<sup>?</sup></label>
                    <!-- <div class="help-tip"> -->
                    <!-- <p>This is the inline help tip! It can contain all kinds of HTML. -->
                    <!-- Style it as you please.</p> -->
                    <!-- </div> -->
                    <!-- </div> -->
                <div class="cell fill">
                    <input class="required fill" id="engine_name" value="TildeMT"
                           onfocus="if (this.value=='TildeMT') this.value='';"
                           placeholder="Name your engine" required />
                </div>
            </div>
            <div class="row">
                <label class="cell" for="client_id_input">Client ID<sup>?</sup></label>
                <div class="cell fill">
                    <input class="fill"
                           id="client_id_input"
                           class="required"
                           placeholder="Click 'Get my Client ID'"
                           required oninput="this.setCustomValidity('')" />
                    <a href="https://readymt.tilde.com/Account/LoginApp"
                       target="_blank"
                       class="clientid-link"
                       id="clientid_link"
                    >Get my Client ID</a>
                </div>
            </div>
        </div>
            <button type="submit" class="ok-button" id="continue_button">Continue</button>
            <button class="cancel-button" id="initial_cancel_button">Cancel</button>
    </form>
</template>

<template id="letsmt_selection_template">
    <style>
    </style>
    <!-- <p class="required pull-left"><sup>*</sup> Required fields.</p> -->
    <!-- Decided to support IE10, hence the nested table madness instead of flexboxes. -->
    <div id="system_config">
        <div id="logout_container" class="fill">
            <button id="logout_button" class="link-button">Log out</button>
        </div>
        <div class="table fill">
            <div class="row error" id="error_message"></div>
            <div class="table fill">
                <div class="cell pad-right" id="source_lang_field" class="pull-left">
                    <div class="table fill">
                        <label class="cell" for="source_select">From</label>
                        <div class="cell fill">
                            <select class="fill" id="source_select"></select>
                        </div>
                    </div>
                </div>
                <div class="cell pad-left" id="target_lang_field" class="pull-right">
                    <div class="table fill">
                        <label class="cell" for="target_select">To</label>
                        <div class="cell fill">
                            <select class="fill" id="target_select"></select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table fill">
                <div class="row" id="system_field" >
                    <label class="cell">Translation system</label>
                    <div class="cell fill">
                        <select id="system_select" class="required fill"></select>
                        <div id="filter_running_field">
                            <input type="checkbox" checked="checked"/>
                            <label class="lighttext">Show running systems only</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <label class="cell">Terms corpora</label>
                    <div class="cell fill">
                        <select class="required fill" id="terms_id"></select>
                    </div>
                </div>
                <div class="row">
                    <div class="cell" id="use_qe_field" class="provider-field pull-left">
                        <label>QE beta</label>
                        <input type="checkbox"/>
                        <!-- <a href="http://www.tilde.com/mt/tools/matecat" target="_blank"  class="info" title="You will see a translation only for segments with a QE (Quality Estimation) beta score above the selected figure."> </a> -->
                    </div>
                    <div class="cell" id="minimum_qe_field" class="provider-field pull-right disabled">
                        <label class="wrap" class="lighttext">Don't show translation if its QE score is below</label>
                        <input class="" id="qe_threshold" type="number" step="0.01" min="0" max="1" value="0" disabled="true"/>
                    </div>
                </div>
            </div>
            <button class="row" id="add_button">Add</button>
        </div>
        <table id="selected_systems" class="fill">
            <thead>
                <tr>
                    <th align="left">Source</th>
                    <th align="left">Target</th>
                    <th align="left">Translation system</th>
                    <th align="left">Terms</th>
                    <th align="left">Remove</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <button class="ok-button" id="save_button">Save</button>
        <button class="cancel-button" id="config_cancel_button">Cancel</button>
    </div>
</template>

<script>
 (function(window, document, undefined) {

     var pluginClient = window.location.hostname;
     var pluginVersion = "1.0";

     // -------------Start ajax helper snippet----------------
     var ajax = {};
     ajax.x = function () {
         if (typeof XMLHttpRequest !== 'undefined') {
             return new XMLHttpRequest();
         }
         var versions = [
             "MSXML2.XmlHttp.6.0",
             "MSXML2.XmlHttp.5.0",
             "MSXML2.XmlHttp.4.0",
             "MSXML2.XmlHttp.3.0",
             "MSXML2.XmlHttp.2.0",
             "Microsoft.XmlHttp"
         ];

         var xhr;
         for (var i = 0; i < versions.length; i++) {
             try {
                 xhr = new ActiveXObject(versions[i]);
                 break;
             } catch (e) {
             }
         }
         return xhr;
     };

     ajax.send = function (url, callback, method, data, errorCallback, customHeaders, async) {
         if (async === undefined) {
             async = true;
         }
         var x = ajax.x();
         x.open(method, url, async);
         x.onreadystatechange = function () {
             if (x.readyState == 4) {
                 if (x.status == 200) {
                    callback(x.responseText);
                 } else if (errorCallback){
                    errorCallback(x.responseText, x.status)
                 };
             }
         };
         if (method == 'POST') {
             x.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
         }
         if (customHeaders) {
             var keys = Object.keys(customHeaders);
             keys.forEach(function(key){
                 x.setRequestHeader(key, customHeaders[key]);
             });
         }
         x.send(data);
     };

     ajax.get = function (url, data, callback, errorCallback, customHeaders, async) {
         var query = [];
         for (var key in data) {
             query.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
         }
         ajax.send(url + (query.length ? '?' + query.join('&') : ''),
                   callback,
                   'GET',
                   null,
                   errorCallback,
                   customHeaders,
                   async);
     };

     ajax.post = function (url, data, callback, errorCallback, customHeaders, async) {
         var query = [];
         for (var key in data) {
             query.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
         }
         ajax.send(url,
                   callback,
                   'POST',
                   query.join('&'),
                   errorCallback,
                   customHeaders,
                   async)
     };
     // -------------End ajax helper snippet----------------


     // Refers to the "importer", which is index.html
     var thatDoc = document;
     // Refers to the "importee", which is src/hello-world.html
     var thisDoc =  (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;
     // Gets content from <template>
     var template = thisDoc.querySelector('template').content;
     // Creates an object based in the HTML Element prototype
     /* var MyElementProto = Object.create(HTMLElement.prototype);*/
     // Creates the "who" attribute and sets a default value

     var Event = function(){
         this.callbacks = [];
     };

     Event.prototype = {
         add: function(callback){
             this.callbacks.push( callback );
         },

         trigger: function(args){
             this.callbacks.forEach(function(callback){
                 if(callback.length > 0){
                     callback(args);
                 } else {
                     callback();
                 }
             });
         },
     };

     var SingleEvent = function(){
         this.callback = null;
     };

     SingleEvent.prototype = {
         add: function(callback){
             this.callback = callback;
         },

         trigger: function(args){
             return this.callback(args);
         },
     };

     var Language = function(id, name){
         this.id = id;
         this.name = name;
     };

     var Status = function(id){
         this.id = id;
         this.name = id in this.statusNames ? this.statusNames[id] : id;
     };

     Status.prototype = {
         statusNames: {
             "running": "Running",
             "queuingtransl": "Queuing",
             "notstarted": "Not Started",
             "nottrained": "Not Trained",
             "error": "Not Trained",
             "training": "Training",
             "standby": "Standby",
         },
     };

     var Term = function(id, name){
         this.id = id;
         this.name = name;
     }

     var Qe = function(available, use, threshold){
         this.available = available;
         this.use = use;
         this.threshold = threshold;
     }

     var System = function(id, name, sourceLang, targetLang, status, terms, qe){
         this.id = id;
         this.name = name;
         this.source = sourceLang;
         this.target = targetLang;
         this.status = status;
         this.terms = terms;
         this.qe = qe;
     };

     var UI = function(shadowRoot){
         this.ShadowRoot = shadowRoot;
         var template = thisDoc.querySelector('#letsmt_initial_template');
         var clone = thatDoc.importNode(template.content, true);
         // Adds a template clone into shadow root
         //var clone = thatDoc.importNode(template, true);
         this.ShadowRoot.appendChild(clone);
         var template = thisDoc.querySelector('#letsmt_selection_template');
         var clone = thatDoc.importNode(template.content, true);
         this.ShadowRoot.appendChild(clone);
         /* $(clone).hide();*/
         this.ContinueClicked = new Event();
         this.AddClicked = new Event();
         this.SaveClicked = new Event();
         this.SystemChanged = new Event();
         this.ShowRunningChanged = new Event();
         this.UseQeChanged = new Event();
         this.SourceChanged = new Event();
         this.TargetChanged = new Event();
         this.InitialSubmitted = new SingleEvent();
         var self = this;
         this.ShadowRoot.getElementById("continue_button")
             .addEventListener("click", function(){self.ContinueClicked.trigger();});
         this.ShadowRoot.getElementById("add_button")
             .addEventListener("click", function(){self.AddClicked.trigger();});
         this.ShadowRoot.getElementById("save_button")
             .addEventListener("click", function(){self.SaveClicked.trigger();});
         this.ShadowRoot.getElementById("system_select")
             .addEventListener("change", function(){self.SystemChanged.trigger();});
         this.ShadowRoot.querySelector("#filter_running_field input")
             .addEventListener("change", function(){self.ShowRunningChanged.trigger();});
         this.ShadowRoot.querySelector("#use_qe_field input")
             .addEventListener("change", function(){self.UseQeChanged.trigger();});
         this.ShadowRoot.querySelector("#source_lang_field select")
             .addEventListener("change", function(){self.SourceChanged.trigger();});
         this.ShadowRoot.querySelector("#target_lang_field select")
             .addEventListener("change", function(){self.TargetChanged.trigger();});
         this.ShadowRoot.getElementById("initial_config")
             .onsubmit = function(){return self.InitialSubmitted.trigger();};

         this.ShadowRoot.getElementById("clientid_link").href += "?Client=" + pluginClient;
     };

     UI.prototype = {
         _getSelection: function(query){
             var field = $(this.ShadowRoot).find(query);
             var value = field.find("option:selected").val();
             var text = field.find("option:selected").text();
             return {value: value, text: text};
         },

         getEngineName: function() {
             return $(this.ShadowRoot).find('#engine_name').val();
         },

         setEngineName: function(value) {
             $(this.ShadowRoot).find('#engine_name').val(value);
         },

         getActiveSource: function() {
             var sel = this._getSelection('#source_lang_field select');
             return new Language(sel.value, sel.text);
         },

         setActiveSource: function(value) {
             var sourceSelect = $(this.ShadowRoot).find('#source_lang_field select');
             sourceSelect.val(value);
         },

         getActiveTarget: function() {
             var sel = this._getSelection('#target_lang_field select');
             return new Language(sel.value, sel.text);
         },

         setActiveTarget: function(value) {
             var targetSelect = $(this.ShadowRoot).find('#target_lang_field select');
             targetSelect.val(value);
         },

         getActiveSystem: function(){
             var sel = this._getSelection('#system_select');
             return new System(sel.value, sel.text);
         },

         setActiveSystem: function(value){
             $(this.ShadowRoot).find("#system_select").val(value);
         },

         getActiveUseQe: function(){
             var useQe = $(this.ShadowRoot).find("#use_qe_field input").prop('checked');
             return useQe;
         },

         getActiveQeThreshold: function(){
             return $(this.ShadowRoot).find("#qe_threshold").val();
         },

         setActiveUseQe: function(value){
             $(this.ShadowRoot).find("#use_qe_field input").prop('checked', value);
         },

         getActiveShowOnlyRunning: function(){
             return $(this.ShadowRoot).find('#filter_running_field input').prop('checked');
         },

         setQeInputEnabled: function(isEnabled){
             $(this.ShadowRoot).find('#minimum_qe_field input').prop('disabled', !isEnabled);
             if (isEnabled) {
                 $(this.ShadowRoot).find('#minimum_qe_field').removeClass('disabled');
             } else {
                 $(this.ShadowRoot).find('#minimum_qe_field').addClass('disabled');
             }
         },

         setQeEnabled: function(isEnabled){
             $(this.ShadowRoot).find('#use_qe_field input').prop("disabled", !isEnabled);
         },

         getActiveTerms: function(){
             var sel = this._getSelection('#terms_id');
             return new Term(sel.value, sel.text);
         },

         setActiveTerms: function(value){
             $(this.ShadowRoot).find('#terms_id').val(value);
         },

         setTermList: function(termList){
             var termsFieldSelector = '#terms_id';
             $(this.ShadowRoot).find(termsFieldSelector).html("");
             var termsSelect = $(this.ShadowRoot).find(termsFieldSelector);
             termsSelect.append("<option value=''>--</option>");
             $('#mt-provider-details .error').text("");
             termList.forEach(function(item){
                 termsSelect.append(this._renderOption(item.id, item.name));
             }.bind(this));
         },

         getClientId: function(){
             return $(this.ShadowRoot).find("#client_id_input")[0].value;
         },

         setClientId: function(value){
             $(this.ShadowRoot).find("#client_id_input").val(value);
         },

         setSources: function(sourceLangs){
             this._setLanguages(sourceLangs, '#source_lang_field select');
         },

         setTargets: function(targetLangs){
             this._setLanguages(targetLangs, '#target_lang_field select');
         },

         _setLanguages: function(langs, selector){
             var select = $(this.ShadowRoot).find(selector);
             select.empty();
             langs.forEach(function(lang){
                 var option = this._renderOption(lang.id, lang.name);
                 select.append(option);
             }.bind(this));
         },

         setSystems: function(systems){
             var systemSelect = $(this.ShadowRoot).find('#system_field select');
             systemSelect.empty();
             systems.forEach(function(system){
                 var option = this._renderOption(
                     system.id,
                     this.getSystemNameHtml(system)
                 );
                 systemSelect.append(option);
             }.bind(this));
         },

         getSystemNameHtml: function(system){
             return system.name + " (" + system.status.name + ")";
         },

         _renderOption: function(value, text){
             return $('<option value="' + value + '">' + text + '</option>');
         },

         triggerSourceChange: function(){
             var sourceSelect = this.ShadowRoot.querySelector('#source_lang_field select');
             sourceSelect.value = (sourceSelect.querySelector("option").value);
             this._triggerChange(sourceSelect);
         },

         triggerTargetChange: function(){
             var targetSelect = this.ShadowRoot.querySelector('#target_lang_field select');
             targetSelect.value = (targetSelect.querySelector("option").value);
             this._triggerChange(targetSelect);
         },

         triggerSystemChange: function(){
             var systemSelect = this.ShadowRoot.querySelector('#system_field select');
             systemSelect.value = (systemSelect.querySelector("option").value);
             this._triggerChange(systemSelect);
         },

         _triggerChange: function(element) {
             if ("createEvent" in document) {
                 var evt = document.createEvent("HTMLEvents");
                 evt.initEvent("change", false, true);
                 element.dispatchEvent(evt);
             }
             else {
                 element.fireEvent("onchange");
             }
         },

         setClientIdError: function(message){
             var clientIdSelect = this.ShadowRoot.querySelector("#client_id_input");
             clientIdSelect.setCustomValidity(message);
             // A bit of a hack to display the HTML5 validation message
             if(message){
                this.ShadowRoot.getElementById("continue_button").click();
             }
         },

         showInitial: function(){
             $(this.ShadowRoot).find("#initial_config").show();
         },

         hideInitial: function(){
             $(this.ShadowRoot).find("#initial_config").hide();
         },

         showConfig: function(){
             $(this.ShadowRoot).find("#system_config").show();
         },

         hideConfig: function(){
             $(this.ShadowRoot).find("#system_config").hide();
         },
     };



     MyElementProto = {

         // Feature detection for old Shadow DOM v0.
         // var USING_SHADOW_DOM_V0 = typeof HTMLElement.prototype.createShadowRoot !== 'undefined';

         // Fires when an instance of the element is created
         createdCallback: function() {

             // Creates the shadow root
             this.systemList = null;
             this.systemDict = {};
             this.selectedSystems = {};
             this.ShadowRoot = this.createShadowRoot();
             this.View = new UI(this.ShadowRoot);
             this.View.InitialSubmitted.add(this.showConfig.bind(this));
             this.View.SourceChanged.add(this._fillTargetLanguages.bind(this));
             this.View.TargetChanged.add(this._filterSystems.bind(this));
             this.View.SystemChanged.add(this.onSystemChange.bind(this));
             this.View.ShowRunningChanged.add(
                 function(){this.createFilters(this.systemList);}.bind(this));
             this.View.UseQeChanged.add(this.toggleQeEnabled.bind(this));
             this.View.AddClicked.add(this.saveActiveSystem.bind(this));
             this.View.SaveClicked.add(this.fireSavedEvent.bind(this));

             this.View.showInitial();
             this.View.hideConfig();
         },
         // Fires when an attribute was added, removed, or updated
         attributeChangedCallback: function(attr, oldVal, newVal) {
         },
         // Fires when an instance was inserted into the document
         attachedCallback: function() {},
         // Fires when an instance was removed from the document
         detachedCallback: function() {},

         _formatLanguageKey: function(source, target){
             return source + "-" + target;
         },

         getSystem: function(source, target){
             var key = this._formatLanguageKey(source, target);
             if (key in this.selectedSystems) {
                 return this.selectedSystems[key];
             }
             return undefined;
         },

         setSystem: function(source, target, systemId, termsId, useQe){
             var key = this._formatLanguageKey(source, target);
             if(systemId){
                this.selectedSystems[key] = {"systemId": systemId, "termsId": termsId, "useQe": useQe};
             }
             else {
                 delete this.selectedSystems[key];
             }
             // TODO: update the GUI
         },

         getSystemById: function(id){
             return this.systemDict[id];
         },

         getActiveSystem: function(){
             var id = this.View.getActiveSystem().id;
             return this.getSystemById(id);
         },

         showConfig: function(){
             var clientId = this.View.getClientId();
             var headers = {
                 "client-id": clientId,
             };
             var url = "https://letsmt.eu/ws/service.svc/json/GetSystemList";
             ajax.get(url,
                      undefined,
                      this.handleResponse.bind(this),
                      this.handleError.bind(this),
                      headers);
             this.View.hideInitial();
             this.View.showConfig();
             return false;
         },

         handleResponse: function(resp) {
             var json = JSON.parse(resp);
             this.systemList = json.System.map(function(elem){
                 var statuses = elem.Metadata.filter(function(data){return data.Key == "status"});
                 var qeTrained = elem.Metadata.filter(function(data){return data.Key == "train-qe-model"});
                 var qeEnabled = elem.Metadata.filter(function(data){return data.Key == "enable-qe"});
                 var qeAvailable = !!qeTrained.length && qeTrained[0].Value == "true"
                                && !!qeEnabled.length && qeEnabled[0].Value == "true";
                 var status = new Status(statuses[0].Value);
                 var source = new Language(elem.SourceLanguage.Code, elem.SourceLanguage.Name.Text)
                 var target = new Language(elem.TargetLanguage.Code, elem.TargetLanguage.Name.Text)
                 var qe = new Qe(qeAvailable, false);
                 return new System(
                     elem.ID,
                     elem.Title.Text,
                     source,
                     target,
                     status,
                     undefined,
                     qe
                 );  // TODO: add terms
             });
             for (var i=0; i<this.systemList.length; i++){
                 var system = this.systemList[i];
                 this.systemDict[system.id] = system;
             }
             this.showNext(this.systemList);
         },

         handleError: function(resp, code){
             if (code == 401){
                 this.View.setClientIdError("Invalid Client ID");
             }
         },

         showNext: function(systemList){
             this.createFilters(systemList);
         },

         onSystemChange: function(){
             this.updateQeAvailability();
             this.fetchTerms();
         },

         updateQeAvailability: function(){
             var system = this.getActiveSystem();
             this.View.setQeEnabled(system.qe.available);
             this.View.setActiveUseQe(system.qe.use);
         },

         fetchTerms: function() {

             var clientId = this.View.getClientId();
             var systemId = this.View.getActiveSystem().id;
             var data = {
                 systemID: systemId,
             };
             var headers = {
                 "client-id": clientId,
             };
             var url = "https://letsmt.eu/ws/service.svc/json/GetSystemTermCorpora";
             ajax.get(url, data, function(jsonString) {
                 var termList = JSON.parse(jsonString);
                 var awailable = termList.filter(function(item){
                     return item.Status == "Ready";
                 });
                 // TODO: check if need to convert to new Term(...)
                 awailable = awailable.map(function(item){
                     return new Term(item.CorpusId, item.Title);
                 });
                 this.View.setTermList(awailable);
             }.bind(this), null, headers);
         },

         toggleQeEnabled: function() {
             var enabled = this.View.getActiveUseQe();
             this.View.setQeInputEnabled(enabled);
         },

         _runningStatuses: { running: true, standby: true },

         _buildDirections: function(systemList, showOnlyRunning){
             var directions = [];
             systemList.forEach(function (elem){
                 var systemStatus = elem.status.id;
                 if(!(systemStatus in this._runningStatuses) && showOnlyRunning) {
                     return;
                 }
                 var sourceCode = elem.source.id;
                 var targetCode = elem.target.id;
                 var sourceName = elem.source.name;
                 var targetName = elem.target.name;
                 if(!(sourceCode in directions)){
                     directions[sourceCode] = {};
                     directions[sourceCode].name = sourceName;
                     directions[sourceCode].target = {};
                 }
                 directions[sourceCode].target[targetCode] = targetName;
             }.bind(this));
             return directions;
         },

         _fillSourceLangs: function(directions){
             var sortedSourceCodes = [];
             for (var sourceCode in directions) {
                 sortedSourceCodes.push(sourceCode);
             }
             sortedSourceCodes.sort();
             var sortedSourceLangs = sortedSourceCodes.map(function(code){
                 return new Language(code, directions[code].name);
             });
             this.View.setSources(sortedSourceLangs);
         },

         _filterSystems: function(){
             var showOnlyRunning = this.View.getActiveShowOnlyRunning();
             var selectedSourceCode = this.View.getActiveSource().id;
             var selectedTargetCode = this.View.getActiveTarget().id;
             var showable = this.systemList.filter(function (elem){
                 var sourceCode = elem.source.id;
                 var targetCode = elem.target.id;
                 var systemStatus = elem.status.id;
                 return sourceCode == selectedSourceCode
                     && targetCode == selectedTargetCode
                      &&((systemStatus in this._runningStatuses) || !showOnlyRunning);
             }.bind(this));
             this.View.setSystems(showable);
             /* var firstAvailableTargetCode = $(systemSelect.find('option').not(function() {*/
             /* return $(this).css("display") == "none";*/
             /* })[0]).val();*/
             /* systemSelect.val(firstAvailableTargetCode).change();*/
             this.View.triggerSystemChange();
         },

         _fillTargetLanguages: function () {
             var directions = this.directions;
             var source = this.View.getActiveSource();
             var targetChoices = directions[source.id].target;
             var sortedTargetCodes = [];
             for (var targetCode in targetChoices) {
                 sortedTargetCodes.push(targetCode);
             }
             sortedTargetCodes.sort();
             var targetLangs = sortedTargetCodes.map(function(code){
                 return new Language(code, targetChoices[code]);
             });
             this.View.setTargets(targetLangs);
             this.View.triggerTargetChange();
         },

         createFilters: function(systemList) {
             var showOnlyRunning = this.View.getActiveShowOnlyRunning();
             // a mapping from available source languages to respective target languages
             this.directions = this._buildDirections(systemList, showOnlyRunning);
             this._fillSourceLangs(this.directions);
             this._fillTargetLanguages();
             this.View.triggerSourceChange();
             this.loadState();
         },

         loadState: function(){
             var state = this.initialState;
             if (state) {
                 Object.keys(state.systems).forEach(function(key){
                     var systemConfig = state.systems[key];
                     var params = systemConfig.params;
                     var system = this.getSystemById(params.systemID);
                     var options = params.options.split(",");
                     var terms = new Term("", "--");
                     var qe = new Qe(false, false, systemConfig.qeThreshold);
                     options.forEach(function(item){
                         var keyval = item.split("=");
                         if (keyval[0] == "termCorpusId"){
                             terms = new Term(keyval[0], keyval[1]);
                         } else if (keyval[0] == "qe"){
                             // can't really be sure, that qe is actually available for this system
                             // TODO: should make some additional check here or something
                             qe.available = true;
                             qe.use = true;
                         }
                     })
                     system.terms = terms;
                     system.qe = qe;
                     this.saveSystem(system);
                 }.bind(this));
                 this.initialState = null;
             }
         },

         renderMTConfigCallback: function() {
             createFilters();
         },

         formatOptions: function(termsCorporaId, useQE, client, clientVersion){
             var options = [];
             // client and clientVersion are expected to be strings. hence the checks
             if (client && client.length && clientVersion && clientVersion.length)
                 {
                     options.push("client=" + client);
                     options.push("version=" + clientVersion);
                 }
             if (termsCorporaId){
                 options.push("termCorpusId=" + termsCorporaId);
             }
             if (useQE){
                 options.push("qe");
             }

             return options.join();
         },

         getClient: function(){
             return pluginClient;
         },

         getVersion: function() {
             return pluginVersion;
         },

         getState: function() {
             var systemConfig = {};
             Object.keys(this.selectedSystems).forEach(function(key){
                 var system = this.selectedSystems[key];
                 system = this.getSystemById(system.systemId);
                 var client = this.getClient();
                 var version = this.getVersion();
                 systemConfig[key] = {
                     qeThreshold: system.qe.threshold,
                     params: {
                        systemID: system.id,
                        options: this.formatOptions(system.terms.id, system.qe.use, client, version),
                     },
                 };
             }.bind(this));
             var clientId = this.View.getClientId();
             var engineName = this.View.getEngineName();
             var state = {
                 "engineName": engineName,
                 "client-id": clientId,
                 "systems": systemConfig,
             };
             return state;
         },

         /* getSystemById: function(systemId){*/
         /* var found = this.systemList.find(function(system){*/
         /* return system.id == systemId;*/
         /* });*/
         /* return found;*/
         /* },*/

         getTermsById: function(termsId){
             var found = this.systemList.find(function(system){
                 return system.id == systemId;
             });
             return found;
         },

         setState: function(state) {
             this.initialState = state;
             this.View.setClientId(state["client-id"]);
             this.View.setEngineName(state.engineName);
             if (!this.systemList){
                 this.showConfig();
             }
         },

         fireSavedEvent: function() {
             var state = this.getState();
             // create custom event instance
             var event = new CustomEvent("save", {detail: state});
             // dispatch event
             this.dispatchEvent(event);
         },

         saveActiveSystem: function(){
             var systemId = this.View.getActiveSystem().id;
             var system = this.getSystemById(systemId);
             var terms = this.View.getActiveTerms();
             var useQe = this.View.getActiveUseQe();
             var qeThreshold = this.View.getActiveQeThreshold();
             system.terms = terms;
             system.qe.use = useQe;
             system.qe.threshold = useQe ? qeThreshold : undefined;
             this.saveSystem(system);
         },

         saveSystem: function(system){
             if(this.getSystem(system.source.id, system.target.id)){
                 this.updateSystem(system.source, system.target, system, system.terms, system.qe.use);
             }
             else {
                 this.addSystem(system.source, system.target, system, system.terms, system.qe.use);
             }
         },

         addSystem: function(source, target, system, terms, useQe){
             var systemTable = this.ShadowRoot.getElementById("selected_systems");
             var row = systemTable.insertRow();
             row.setAttribute("id", this._formatLanguageKey(source.id, target.id));
             this.addSystemToRow(row, source, target, system, terms);
             this.setSystem(source.id, target.id, system.id, terms.id, useQe);
         },

         updateSystem: function(source, target, system, terms, useQe){
             var row = this.ShadowRoot.getElementById(this._formatLanguageKey(source.id, target.id));
             row.innerHTML = "";
             this.addSystemToRow(row, source, target, system, terms);
             this.setSystem(source.id, target.id, system.id, terms.id, useQe);
         },

         addSystemToRow: function(row, source, target, system, terms){
             [source.name, target.name, system.name, terms.name,
              "<button class='remove-button'>x</button>"].forEach(function(elem){
                 var cell = row.insertCell();
                 cell.innerHTML = elem;
             });
             row.querySelector("button").addEventListener("click", this.removeClicked.bind(this));
         },

         removeClicked: function(event){
             var button = event.target;
             var row = button.parentElement.parentElement;
             var id = row.getAttribute("id");
             var ids = id.split("-")
             row.parentElement.removeChild(row);
             this.setSystem(ids[0], ids[1], undefined);
         },
     };

     MyElementProto.__proto__ = HTMLElement.prototype;

     // Registers <tildemt-selector> in the main document
     window.MyElement = thatDoc.registerElement('tildemt-selector', {
         prototype: MyElementProto
     });
 })(window, document);
</script>
