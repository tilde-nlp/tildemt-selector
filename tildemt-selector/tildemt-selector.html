<!-- Defines element markup -->
<template id="letsmt_initial_template">
    <style>
     #header_container {
         padding-bottom: 0.5em;
         margin-bottom: 2em;
         border-bottom: 1px solid #EFEFEF;
     }

     .logo-top {
         display: block;
         width: 200px;
         height: 40px;
         background: url('https://www.letsmt.eu/images/mt.svg');
         background-size: contain;
         background-repeat: no-repeat;
     }

     .error {
         color: red;
     }
     .table {
         display: table;
     }
     .row {
         display: table-row;
     }
     .cell {
         display: table-cell;
         padding-bottom: 1em;
     }

     table {
         padding: 0em;
         border: 0px;
         border-collapse: collapse;
     }

     .table-wrap {
         background-color: #F7F7F7;
     }

     table caption {
         text-align: left;
         padding: 1em 2em;
         font-weight: bold;
         border-bottom: 2px solid #EFEFEF;
         box-shadow: inset 0px 5px 4px -4px #C9C9C9
     }

     table tr:nth-child(even) {
         background-color: #FCFCFC;
     }

     table th {
         padding: 1em 0.5em 0.7em 0.5em;
     }

     table td:first-child, table th:first-child {
         padding-left: 2em;
     }

     table td {
         padding: 0em 0.5em;
         border-bottom: 1px solid #EFEFEF;
         height: 2em;
     }

     .clientid-link {
         display: block;
         margin-top: 0.6em;
         font-size: 90%;
     }
     .fill {
         width: 100%;
     }
     .row label, label.cell {
         padding-right: 1em;
         white-space: nowrap;
     }
     .cell.pad-right {
         padding-right: 1em;
     }
     .cell.pad-left {
         padding-left: 1em;
     }

     form label{
        display: inline-block;
        font-size: 92%;
         /* line-height: 100%; */
        color: #4C3A3F;
     }

     form {
         font-family: "Avenir LT W02 45 Book", sans-serif;
     }

     form input, form button{
         font-family: inherit;
     }

     form button {
         background-color: #BF1A37;
         padding: 0 1em;
         text-decoration: none;
         color: white;
         height: 1.767em;
         font-size: 92%;
         border: 0;
         cursor: pointer;
         vertical-align: top;
         min-width: 6em;
     }

     .remove-button {
         background-color: initial;
         padding: initial;
         text-decoration: initial;
         color: initial;
         height: initial;
         font-size: initial;
         border: initial;
         cursor: pointer;
         vertical-align: initial;
         min-width: initial;
         padding: 0 3px;
     }

     .remove-button:hover {
         outline: none;
         border-color: #BF1A37;
         /* box-shadow: 0 0 7px #9ECAED, inset 0 0 1px #9ECAED; */
         text-shadow: 0 0 3px black;
     }

     .align-right-container {
         text-align: right;
     }

     /* .row label .wrap { */
     /* white-space: wrap; */
     /* } */
     input, select {
         height: 2em;
     }
     button {
         padding: 0.3em 0.6em;
     }
     .table input[type="checkbox"] {
         width: 1.3em;
         height: 1.3em;
     }
     .ok-button, .cancel-button {
         display:inline-block;
         margin-top: 2em;
     }

     .ok-button {
         margin-right: 1em;
     }

     .link-button {
        background:none!important;
        border:none; 
        padding:0!important;
        font: inherit;
        /*border is optional*/
        border-bottom:1px solid #444; 
        cursor: pointer;
        background-color: initial;
        text-decoration: initial;
        color: initial;
        height: initial;
        margin: initial;
        font-size: initial;
        vertical-align: initial;
        min-width: initial;
     }

     #logout_container {
         text-align: right;
         margin-bottom: 1em;
     }

     #selected_systems tbody tr{
         cursor: pointer;
     }

     #selected_systems {
         margin-top: 2em;
     }

    .help-tip{
        position: absolute;
        top: 18px;
        right: 18px;
        text-align: center;
        background-color: #BCDBEA;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 14px;
        line-height: 26px;
        cursor: default;
    }

    .help-tip:before{
        content:'?';
        font-weight: bold;
        color:#fff;
    }

    .help-tip:hover p{
        display:block;
        transform-origin: 100% 0%;

        -webkit-animation: fadeIn 0.3s ease-in-out;
        animation: fadeIn 0.3s ease-in-out;

    }

    .help-tip p{	/* The tooltip */
        display: none;
        text-align: left;
        background-color: #1E2021;
        padding: 20px;
        width: 300px;
        position: absolute;
        border-radius: 3px;
        box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
        right: -4px;
        color: #FFF;
        font-size: 13px;
        line-height: 1.4;
    }

    .help-tip p:before{ /* The pointer of the tooltip */
        position: absolute;
        content: '';
        width:0;
        height: 0;
        border:6px solid transparent;
        border-bottom-color:#1E2021;
        right:10px;
        top:-12px;
    }

    .help-tip p:after{ /* Prevents the tooltip from being hidden */
        width:100%;
        height:40px;
        content:'';
        position: absolute;
        top:-40px;
        left:0;
    }

        /* CSS animation */

    @-webkit-keyframes fadeIn {
        0% { 
            opacity:0; 
            transform: scale(0.6);
        }

        100% {
            opacity:100%;
            transform: scale(1);
        }
    }

    @keyframes fadeIn {
        0% { opacity:0; }
        100% { opacity:100%; }
    }
    </style>
    <div id="header_container">
        <div class="logo-top"></div>
    </div>
    <form id="initial_config" action="">
        <div class="table">
            <div class="error" id="error_message"></div>
            <div class="row" id="name-row">
                <!-- <div class="cell"> -->
                    <label class="cell" for="engine_name">Engine name<sup>?</sup></label>
                    <!-- <div class="help-tip"> -->
                    <!-- <p>This is the inline help tip! It can contain all kinds of HTML. -->
                    <!-- Style it as you please.</p> -->
                    <!-- </div> -->
                    <!-- </div> -->
                <div class="cell fill">
                    <input class="required fill" id="engine_name" value="TildeMT"
                           onfocus="if (this.value=='TildeMT') this.value='';"
                           placeholder="Name your engine" required />
                </div>
            </div>
            <div class="row">
                <label class="cell" for="client_id_input">Client ID<sup>?</sup></label>
                <div class="cell fill">
                    <input class="fill"
                           id="client_id_input"
                           class="required"
                           placeholder="Click 'Get my Client ID'"
                           required oninput="this.setCustomValidity('')" />
                    <a href="https://readymt.tilde.com/Account/LoginApp"
                       target="_blank"
                       class="clientid-link"
                       id="clientid_link"
                    >Get my Client ID</a>
                </div>
            </div>
        </div>
        <div class="align-right-container">
            <button type="submit" class="ok-button" id="continue_button">Continue</button>
            <button type="button" class="cancel-button" id="initial_cancel_button">Cancel</button>
        </div>
    </form>
</template>

<template id="letsmt_selection_template">
    <style>
    </style>
    <!-- <p class="required pull-left"><sup>*</sup> Required fields.</p> -->
    <!-- Decided to support IE10, hence the nested table madness instead of flexboxes. -->
    <form id="system_config" action="">
        <div id="logout_container" class="fill">
            <button type="button" id="logout_button" class="link-button">Log out</button>
        </div>
        <div class="table fill">
            <div class="row error" id="error_message"></div>
            <div class="table fill">
                <div class="cell pad-right" id="source_lang_field" class="pull-left">
                    <div class="table fill">
                        <label class="cell" for="source_select">From</label>
                        <div class="cell fill">
                            <select class="fill" id="source_select"></select>
                        </div>
                    </div>
                </div>
                <div class="cell pad-left" id="target_lang_field" class="pull-right">
                    <div class="table fill">
                        <label class="cell" for="target_select">To</label>
                        <div class="cell fill">
                            <select class="fill" id="target_select"></select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table fill">
                <div class="row" id="system_field" >
                    <label class="cell">Translation system</label>
                    <div class="cell fill">
                        <select id="system_select" class="required fill"></select>
                        <div id="filter_running_field">
                            <input type="checkbox" checked="checked"/>
                            <label class="lighttext">Show running systems only</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <label class="cell">Terms corpora</label>
                    <div class="cell fill">
                        <select class="required fill" id="terms_id"></select>
                    </div>
                </div>
                <div class="row">
                    <div class="cell" id="use_qe_field" class="provider-field pull-left">
                        <label>QE beta</label>
                        <input type="checkbox"/>
                        <!-- <a href="http://www.tilde.com/mt/tools/matecat" target="_blank"  class="info" title="You will see a translation only for segments with a QE (Quality Estimation) beta score above the selected figure."> </a> -->
                    </div>
                    <div class="cell" id="minimum_qe_field" class="provider-field pull-right disabled">
                        <label class="wrap" class="lighttext">Don't show translation if its QE score is below</label>
                        <input class="" id="qe_threshold" type="number" step="0.01" min="0" max="1" value="0" disabled="true"/>
                    </div>
                </div>
            </div>
            <div class="align-right-container">
                <button type="submit" class="row" id="add_button">Add</button>
            </div>
        </div>
        <div class="table-wrap">
            <table id="selected_systems" class="fill">
                <caption>Selected systems</caption>
                <thead>
                    <tr>
                        <th align="left">Source</th>
                        <th align="left">Target</th>
                        <th align="left">Translation system</th>
                        <th align="center">Terms</th>
                        <th align="center">Remove</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="error" id="error" style="display: none"></div>
        <div class="align-right-container" id="save_buttons">
            <button type="button" class="ok-button" id="save_button">Save</button>
            <button type="button" class="cancel-button" id="config_cancel_button">Cancel</button>
        </div>
    </form>
</template>

<script>
 (function(window, document, undefined) {

     var pluginClient = window.location.hostname;
     var pluginVersion = "1.0";

     // -------------Start ajax helper snippet----------------
     var ajax = {};
     ajax.x = function () {
         if (typeof XMLHttpRequest !== 'undefined') {
             return new XMLHttpRequest();
         }
         var versions = [
             "MSXML2.XmlHttp.6.0",
             "MSXML2.XmlHttp.5.0",
             "MSXML2.XmlHttp.4.0",
             "MSXML2.XmlHttp.3.0",
             "MSXML2.XmlHttp.2.0",
             "Microsoft.XmlHttp"
         ];

         var xhr;
         for (var i = 0; i < versions.length; i++) {
             try {
                 xhr = new ActiveXObject(versions[i]);
                 break;
             } catch (e) {
             }
         }
         return xhr;
     };

     ajax.send = function (url, callback, method, data, errorCallback, customHeaders, async) {
         if (async === undefined) {
             async = true;
         }
         var x = ajax.x();
         x.open(method, url, async);
         x.onreadystatechange = function () {
             if (x.readyState == 4) {
                 if (x.status == 200) {
                    callback(x.responseText);
                 } else if (errorCallback){
                    errorCallback(x.responseText, x.status)
                 };
             }
         };
         if (method == 'POST') {
             x.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
         }
         if (customHeaders) {
             var keys = Object.keys(customHeaders);
             keys.forEach(function(key){
                 x.setRequestHeader(key, customHeaders[key]);
             });
         }
         x.send(data);
     };

     ajax.get = function (url, data, callback, errorCallback, customHeaders, async) {
         var query = [];
         for (var key in data) {
             query.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
         }
         ajax.send(url + (query.length ? '?' + query.join('&') : ''),
                   callback,
                   'GET',
                   null,
                   errorCallback,
                   customHeaders,
                   async);
     };

     ajax.post = function (url, data, callback, errorCallback, customHeaders, async) {
         var query = [];
         for (var key in data) {
             query.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));
         }
         ajax.send(url,
                   callback,
                   'POST',
                   query.join('&'),
                   errorCallback,
                   customHeaders,
                   async)
     };
     // -------------End ajax helper snippet----------------


     // Refers to the "importer", which is index.html
     var thatDoc = document;
     // Refers to the "importee", which is src/hello-world.html
     var thisDoc =  (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;
     // Gets content from <template>
     var template = thisDoc.querySelector('template').content;
     // Creates an object based in the HTML Element prototype
     /* var MyElementProto = Object.create(HTMLElement.prototype);*/
     // Creates the "who" attribute and sets a default value

     var Event = function(){
         this.callbacks = [];
     };

     Event.prototype = {
         add: function(callback){
             this.callbacks.push( callback );
         },

         trigger: function(args){
             this.callbacks.forEach(function(callback){
                 if(callback.length > 0){
                     callback(args);
                 } else {
                     callback();
                 }
             });
         },
     };

     var SingleEvent = function(){
         this.callback = null;
     };

     SingleEvent.prototype = {
         add: function(callback){
             this.callback = callback;
         },

         trigger: function(args){
             return this.callback(args);
         },
     };

     var Language = function(id, name){
         this.id = id;
         this.name = name;
     };

     var Status = function(id){
         this.id = id;
         this.name = id in this.statusNames ? this.statusNames[id] : id;
     };

     Status.prototype = {
         statusNames: {
             "running": "Running",
             "queuingtransl": "Queuing",
             "notstarted": "Not Started",
             "nottrained": "Not Trained",
             "error": "Not Trained",
             "training": "Training",
             "standby": "Standby",
         },
     };

     var Term = function(id, name){
         this.id = id;
         this.name = name;
     }

     var Qe = function(available, use, threshold){
         this.available = available;
         this.use = use;
         this.threshold = threshold;
     }

     var System = function(id, name, sourceLang, targetLang, status, terms, qe){
         this.id = id;
         this.name = name;
         this.source = sourceLang;
         this.target = targetLang;
         this.status = status;
         this.terms = terms;
         this.qe = qe;
     };

     var _formatLanguageKey = function(source, target){
         return source + "-" + target;
     };

     var removeClass = function(element, classname){
         element.className
            .replace(new RegExp('(?:^|\\s)'+ classname + '(?:\\s|$)'), ' ');
     };

     var addClass = function(element, classname){
         element.className += " " + classname;
     };

     var hide = function(element){
         element.style.display = "none";
     };

     var show = function(element){
         // NOTE: this works only if the element didn't have an
         // inline style for display: defined before calling hide()
         if (element.style.display == "none") {
             element.style.display = null;
         }
     };

     var UI = function(shadowRoot){
         this.ShadowRoot = shadowRoot;
         var template = thisDoc.querySelector('#letsmt_initial_template');
         var clone = thatDoc.importNode(template.content, true);
         // Adds a template clone into shadow root
         //var clone = thatDoc.importNode(template, true);
         this.ShadowRoot.appendChild(clone);
         var template = thisDoc.querySelector('#letsmt_selection_template');
         var clone = thatDoc.importNode(template.content, true);
         this.ShadowRoot.appendChild(clone);
         this.ContinueClicked = new Event();
         this.AddClicked = new Event();
         this.SaveClicked = new Event();
         this.InitialCancelClicked = new Event();
         this.ConfigCancelClicked = new Event();
         this.LogoutClicked = new Event();
         this.RemoveClicked = new Event();
         this.SelectedSystemClicked = new Event();
         this.SystemChanged = new Event();
         this.ShowRunningChanged = new Event();
         this.UseQeChanged = new Event();
         this.SourceChanged = new Event();
         this.TargetChanged = new Event();
         this.InitialSubmitted = new SingleEvent();
         this.ConfigSubmitted = new SingleEvent();
         var self = this;
         this.ShadowRoot.getElementById("continue_button")
             .addEventListener("click", function(){self.ContinueClicked.trigger();});
         this.ShadowRoot.getElementById("initial_cancel_button")
             .addEventListener("click", function(){self.InitialCancelClicked.trigger();});
         this.ShadowRoot.getElementById("config_cancel_button")
             .addEventListener("click", function(){self.ConfigCancelClicked.trigger();});
         this.ShadowRoot.getElementById("logout_button")
             .addEventListener("click", function(){self.LogoutClicked.trigger();});
         this.ShadowRoot.getElementById("add_button")
             .addEventListener("click", function(){self.AddClicked.trigger();});
         this.ShadowRoot.getElementById("save_button")
             .addEventListener("click", function(){self.SaveClicked.trigger();});
         this.ShadowRoot.getElementById("system_select")
             .addEventListener("change", function(){self.SystemChanged.trigger();});
         this.ShadowRoot.querySelector("#filter_running_field input")
             .addEventListener("change", function(){self.ShowRunningChanged.trigger();});
         this.ShadowRoot.querySelector("#use_qe_field input")
             .addEventListener("change", function(){self.UseQeChanged.trigger();});
         this.ShadowRoot.querySelector("#source_lang_field select")
             .addEventListener("change", function(){self.SourceChanged.trigger();});
         this.ShadowRoot.querySelector("#target_lang_field select")
             .addEventListener("change", function(){self.TargetChanged.trigger();});
         this.ShadowRoot.getElementById("initial_config")
             .onsubmit = function(){return self.InitialSubmitted.trigger();};
         this.ShadowRoot.getElementById("system_config")
             .onsubmit = function(){return self.ConfigSubmitted.trigger();};

         this.ShadowRoot.getElementById("clientid_link").href += "?Client=" + pluginClient;
     };

     UI.prototype = {
         _getSelection: function(query){
             var select = this.ShadowRoot.querySelector(query);
             if (select.selectedIndex < 0){
                 return undefined;
             }
             var value = select.options[select.selectedIndex].value;
             var text = select.options[select.selectedIndex].text;
             return {value: value, text: text};
         },

         getEngineName: function() {
             return this.ShadowRoot.getElementById('engine_name').value;
         },

         setEngineName: function(value) {
             this.ShadowRoot.querySelector('#engine_name').value;
         },

         setActive: function(system) {
             this.setActiveSource(system.source.id);
             /* this.triggerTargetChange();*/
             this.setActiveTarget(system.target.id);
             /* this.triggerSystemChange();*/
             this.setActiveSystem(system.id);
             /* this.triggerSystemChange();*/
         },

         getActiveSource: function() {
             var sel = this._getSelection('#source_lang_field select');
             if (!sel) {
                 return undefined;
             }
             return new Language(sel.value, sel.text);
         },

         _setValue: function(value, querySelector){
             var element = this.ShadowRoot.querySelector(querySelector);
             element.value = value;
             this._triggerChange(element);
         },

         setActiveSource: function(value) {
             this._setValue(value, '#source_lang_field select');
         },

         getActiveTarget: function() {
             var sel = this._getSelection('#target_lang_field select');
             if (!sel) {
                 return undefined;
             }
             return new Language(sel.value, sel.text);
         },

         setActiveTarget: function(value) {
             this._setValue(value, '#target_lang_field select');
         },

         getActiveSystem: function(){
             var sel = this._getSelection('#system_select');
             if (!sel) {
                 return undefined;
             }
             return new System(sel.value, sel.text);
         },

         setActiveSystem: function(value){
            this._setValue(value, "#system_select");
         },

         getActiveUseQe: function(){
             var useQe = this.ShadowRoot.querySelector("#use_qe_field input").checked;
             return useQe;
         },

         getActiveQeThreshold: function(){
             return this.ShadowRoot.querySelector("#qe_threshold").value;
         },

         setActiveQeThreshold: function(value){
             this.ShadowRoot.querySelector("#qe_threshold").value = value;
         },

         setActiveUseQe: function(value){
             var checkbox = this.ShadowRoot.querySelector("#use_qe_field input");
             checkbox.checked = value;
             this._triggerChange(checkbox);
         },

         getActiveShowOnlyRunning: function(){
             return this.ShadowRoot.querySelector('#filter_running_field input').checked;
         },

         setQeInputEnabled: function(isEnabled){
             this.ShadowRoot.querySelector('#minimum_qe_field input').disabled = !isEnabled;
             if (isEnabled) {
                 removeClass(this.ShadowRoot.querySelector('#minimum_qe_field'), 'disabled');
             } else {
                 addClass(this.ShadowRoot.querySelector('#minimum_qe_field'), 'disabled');
             }
         },

         setQeEnabled: function(isEnabled){
             this.ShadowRoot.querySelector('#use_qe_field input').disabled = !isEnabled;
         },

         getActiveTerms: function(){
             var sel = this._getSelection('#terms_id');
             if (!sel) {
                 return undefined;
             }
             return new Term(sel.value, sel.text);
         },

         setActiveTerms: function(value){
             this.ShadowRoot.querySelector('#terms_id').value = value;
         },

         setTermList: function(termList){
             var termsFieldSelector = '#terms_id';
             this.ShadowRoot.querySelector(termsFieldSelector).innerHTML = "";
             var termsSelect = this.ShadowRoot.querySelector(termsFieldSelector);
             termsSelect.appendChild(this._createOption('', '--'));
             /* $('#mt-provider-details .error').text("");*/
             termList.forEach(function(item){
                 termsSelect.appendChild(this._createOption(item.id, item.name));
             }.bind(this));
         },

         getClientId: function(){
             return this.ShadowRoot.querySelector("#client_id_input").value;
         },

         setClientId: function(value){
             this.ShadowRoot.querySelector("#client_id_input").value = value;
         },

         setSources: function(sourceLangs){
             this._setLanguages(sourceLangs, '#source_lang_field select');
         },

         setTargets: function(targetLangs){
             this._setLanguages(targetLangs, '#target_lang_field select');
         },

         _setLanguages: function(langs, selector){
             var select = this.ShadowRoot.querySelector(selector);
             select.innerHTML = "";
             langs.forEach(function(lang){
                 var option = this._createOption(lang.id, lang.name);
                 select.appendChild(option);
             }.bind(this));
         },

         setSystems: function(systems){
             var systemSelect = this.ShadowRoot.querySelector('#system_field select');
             systemSelect.innerHTML = "";
             systems.forEach(function(system){
                 var option = this._createOption(
                     system.id,
                     this.getSystemNameHtml(system)
                 );
                 systemSelect.appendChild(option);
             }.bind(this));
         },

         getSystemNameHtml: function(system){
             return system.name + " (" + system.status.name + ")";
         },

         _createOption: function(value, text){
             var opt = document.createElement('option');
             opt.value = value;
             opt.innerHTML = text;
             return opt;
         },

         triggerSourceChange: function(){
             var sourceSelect = this.ShadowRoot.querySelector('#source_lang_field select');
             sourceSelect.value = (sourceSelect.querySelector("option").value);
             this._triggerChange(sourceSelect);
         },

         triggerTargetChange: function(){
             var targetSelect = this.ShadowRoot.querySelector('#target_lang_field select');
             targetSelect.value = (targetSelect.querySelector("option").value);
             this._triggerChange(targetSelect);
         },

         triggerSystemChange: function(){
             var systemSelect = this.ShadowRoot.querySelector('#system_field select');
             systemSelect.value = (systemSelect.querySelector("option").value);
             this._triggerChange(systemSelect);
         },

         _triggerChange: function(element) {
             if ("createEvent" in document) {
                 var evt = document.createEvent("HTMLEvents");
                 evt.initEvent("change", false, true);
                 element.dispatchEvent(evt);
             }
             else {
                 element.fireEvent("onchange");
             }
         },

         setClientIdError: function(message){
             var clientIdSelect = this.ShadowRoot.querySelector("#client_id_input");
             clientIdSelect.setCustomValidity(message);
             // A bit of a hack to display the HTML5 validation message
             if(message){
                this.ShadowRoot.getElementById("continue_button").click();
             }
         },

         showInitial: function(){
             show(this.ShadowRoot.querySelector("#initial_config"));
         },

         hideInitial: function(){
             hide(this.ShadowRoot.querySelector("#initial_config"));
         },

         showConfig: function(){
             show(this.ShadowRoot.querySelector("#system_config"));
         },

         hideConfig: function(){
             hide(this.ShadowRoot.querySelector("#system_config"));
         },

         clearSystems: function(){
             var systemTable = this.ShadowRoot.querySelector("#selected_systems tbody");
             /* var tbody = systemTable.querySelector("tbody");*/
             /* var empty = document.createElement('tbody');*/
             /* systemTable.replaceChild(empty, tbody);*/
             while(systemTable.rows.length > 0) {
                 systemTable.deleteRow(0);
             }
         },

         addSystem: function(system){
             var systemTable = this.ShadowRoot.querySelector("#selected_systems tbody");
             var row = systemTable.insertRow();
             row.setAttribute("id", _formatLanguageKey(system.source.id, system.target.id));
             this.addSystemToRow(system, row);
         },

         updateSystem: function(system){
             var row = this.ShadowRoot.getElementById(
                 _formatLanguageKey(system.source.id, system.target.id));
             row.innerHTML = "";
             this.addSystemToRow(system, row);
         },

         addSystemToRow: function(system, row){
             var toadd = [system.source.name, system.target.name, system.name, system.terms.name,
                          "<button type='button' class='remove-button'>&#10006;</button>"];
             for (var i=0; i < toadd.length; i++){
                 var elem = toadd[i];
                 var cell = row.insertCell();
                 // some elements need to be centered
                 if (i == 3 || i == 4) {
                     cell.setAttribute("align", "center");
                 }
                 cell.innerHTML = elem;
             }
             row.querySelector("button").addEventListener("click",
                function(event){this.RemoveClicked.trigger(event);}.bind(this));
             row.addEventListener("click",
                function(event){this.SelectedSystemClicked.trigger(event);}.bind(this));
         },

         setError: function(message){
             var elem = this.ShadowRoot.getElementById("error");
             elem.innerHTML = message;
             if (message) {
                 show(elem);
             } else {
                 hide(elem);
             }
         },

         hideSaveButtons: function(){
             hide(this.ShadowRoot.getElementById("save_buttons"));
         },

         showSaveButtons: function(){
             show(this.ShadowRoot.getElementById("save_buttons"));
         },

         hideName: function(){
             hide(this.ShadowRoot.getElementById("name-row"));
             this.ShadowRoot.getElementById("engine_name").setAttribute("disabled", "");
         },

         showName: function(){
             show(this.ShadowRoot.getElementById("name-row"));
             this.ShadowRoot.getElementById("engine_name").removeAttribute("disabled"); 
         },
     };



     MyElementProto = {

         hiddensave: false,
         hiddenname: false,

         // Feature detection for old Shadow DOM v0.
         // var USING_SHADOW_DOM_V0 = typeof HTMLElement.prototype.createShadowRoot !== 'undefined';

         // Fires when an instance of the element is created
         createdCallback: function() {

             // Creates the shadow root
             this.systemList = null;
             this.systemDict = {};
             this.selectedSystems = {};
             this.ShadowRoot = this.createShadowRoot();

             this.View = new UI(this.ShadowRoot);
             this.View.InitialSubmitted.add(this.showConfig.bind(this));
             this.View.ConfigSubmitted.add(this.onConfigSubmit.bind(this));
             this.View.SourceChanged.add(this._fillTargetLanguages.bind(this));
             this.View.TargetChanged.add(this._filterSystems.bind(this));
             this.View.SystemChanged.add(this.onSystemChange.bind(this));
             this.View.ShowRunningChanged.add(
                 function(){this.createFilters(this.systemList);}.bind(this));
             this.View.UseQeChanged.add(this.toggleQeEnabled.bind(this));
             /* this.View.AddClicked.add(this.saveActiveSystem.bind(this));*/
             this.View.SaveClicked.add(this.onSave.bind(this));
             this.View.InitialCancelClicked.add(this.onCancel.bind(this));
             this.View.ConfigCancelClicked.add(this.onCancel.bind(this));
             this.View.RemoveClicked.add(this.removeClicked.bind(this));
             this.View.LogoutClicked.add(this.onLogout.bind(this));
             this.View.SelectedSystemClicked.add(this.onSystemEdit.bind(this));

             this.View.showInitial();
             this.View.hideConfig();

             this.refreshHiddenSave();
             this.refreshHiddenName();
         },
         // Fires when an attribute was added, removed, or updated
         attributeChangedCallback: function(attr, oldVal, newVal) {
             if(attr == "hiddensave") {
                this.refreshHiddenSave();
             } else if (attr == "hiddenname") {
                 this.refreshHiddenName();
             }
         },
         // Fires when an instance was inserted into the document
         attachedCallback: function() {},
         // Fires when an instance was removed from the document
         detachedCallback: function() {},

         refreshHiddenSave: function() {
             // Check if "hiddensave" is defined on the custom element
             if (this.hasAttribute("hiddensave")) {
                 this.setHiddenSave(true);
             } else {
                 this.setHiddenSave(false);
             }
         },

         setHiddenSave: function(val) {
             if (this.hiddensave != val) {
                this.hiddensave = val;
             }
             if (val) {
                 this.View.hideSaveButtons();
             } else {
                 this.View.showSaveButtons();
             }
         },

         refreshHiddenName: function() {
             // Check if "hiddenname" is defined on the custom element
             if (this.hasAttribute("hiddenname")) {
                 this.setHiddenName(true);
             } else {
                 this.setHiddenName(false);
             }
         },

         setHiddenName: function(val) {
             if (this.hiddenname != val) {
                this.hiddenname = val;
             }
             if (val) {
                 this.View.hideName();
             } else {
                 this.View.showName();
             }
         },

         getSystem: function(source, target){
             var key = _formatLanguageKey(source, target);
             if (key in this.selectedSystems) {
                 return this.selectedSystems[key];
             }
             return undefined;
         },

         setSystem: function(source, target, systemId, termsId, useQe){
             var key = _formatLanguageKey(source, target);
             if(systemId){
                this.selectedSystems[key] = {"systemId": systemId, "termsId": termsId, "useQe": useQe};
             }
             else {
                 delete this.selectedSystems[key];
             }
             // TODO: update the GUI
         },

         getSystemById: function(id){
             return this.systemDict[id];
         },

         getActiveSystem: function(){
             var id = this.View.getActiveSystem().id;
             return this.getSystemById(id);
         },

         showConfig: function(){
             this.View.setError("");
             var clientId = this.View.getClientId();
             var headers = {
                 "client-id": clientId,
             };
             var url = "https://letsmt.eu/ws/service.svc/json/GetSystemList";
             ajax.get(url,
                      undefined,
                      this.handleResponse.bind(this),
                      this.handleError.bind(this),
                      headers);
             return false;  // return false to stop the form submit
         },

         handleResponse: function(resp) {
             var json = JSON.parse(resp);
             this.systemList = json.System.map(function(elem){
                 var statuses = elem.Metadata.filter(function(data){return data.Key == "status"});
                 var qeTrained = elem.Metadata.filter(function(data){return data.Key == "train-qe-model"});
                 var qeEnabled = elem.Metadata.filter(function(data){return data.Key == "enable-qe"});
                 var qeAvailable = !!qeTrained.length && qeTrained[0].Value == "true"
                                && !!qeEnabled.length && qeEnabled[0].Value == "true";
                 var status = new Status(statuses[0].Value);
                 var source = new Language(elem.SourceLanguage.Code, elem.SourceLanguage.Name.Text)
                 var target = new Language(elem.TargetLanguage.Code, elem.TargetLanguage.Name.Text)
                 var qe = new Qe(qeAvailable, false);
                 return new System(
                     elem.ID,
                     elem.Title.Text,
                     source,
                     target,
                     status,
                     undefined,
                     qe
                 );  // TODO: add terms
             });
             for (var i=0; i<this.systemList.length; i++){
                 var system = this.systemList[i];
                 this.systemDict[system.id] = system;
             }
             this.showNext(this.systemList);
         },

         handleError: function(resp, code){
             if (code == 401){
                 this.View.setClientIdError("Invalid Client ID");
             }
         },

         showNext: function(systemList){
             this.createFilters(systemList);
         },

         onSystemChange: function(){
             this.updateQeFields();
             this.fetchTerms();
         },

         updateQeFields: function(){
             var system = this.getActiveSystem();
             this.View.setQeEnabled(system.qe.available);
             this.View.setActiveUseQe(system.qe.use);
             this.View.setActiveQeThreshold(system.qe.threshold ? system.qe.threshold : 0);
         },

         fetchTerms: function() {

             var clientId = this.View.getClientId();
             var systemId = this.View.getActiveSystem().id;
             var data = {
                 systemID: systemId,
             };
             var headers = {
                 "client-id": clientId,
             };
             var url = "https://letsmt.eu/ws/service.svc/json/GetSystemTermCorpora";
             ajax.get(url, data, function(jsonString) {
                 var termList = JSON.parse(jsonString);
                 var awailable = termList.filter(function(item){
                     return item.Status == "Ready";
                 });
                 // TODO: check if need to convert to new Term(...)
                 awailable = awailable.map(function(item){
                     return new Term(item.CorpusId, item.Title);
                 });
                 this.View.setTermList(awailable);
             }.bind(this), null, headers);
         },

         toggleQeEnabled: function() {
             var enabled = this.View.getActiveUseQe();
             this.View.setQeInputEnabled(enabled);
         },

         _runningStatuses: { running: true, standby: true },

         _buildDirections: function(systemList, showOnlyRunning){
             var directions = [];
             systemList.forEach(function (elem){
                 var systemStatus = elem.status.id;
                 if(!(systemStatus in this._runningStatuses) && showOnlyRunning) {
                     return;
                 }
                 var sourceCode = elem.source.id;
                 var targetCode = elem.target.id;
                 var sourceName = elem.source.name;
                 var targetName = elem.target.name;
                 if(!(sourceCode in directions)){
                     directions[sourceCode] = {};
                     directions[sourceCode].name = sourceName;
                     directions[sourceCode].target = {};
                 }
                 directions[sourceCode].target[targetCode] = targetName;
             }.bind(this));
             return directions;
         },

         _fillSourceLangs: function(directions){
             var sortedSourceCodes = [];
             for (var sourceCode in directions) {
                 sortedSourceCodes.push(sourceCode);
             }
             sortedSourceCodes.sort();
             var sortedSourceLangs = sortedSourceCodes.map(function(code){
                 return new Language(code, directions[code].name);
             });
             this.View.setSources(sortedSourceLangs);
         },

         _filterSystems: function(){
             var showOnlyRunning = this.View.getActiveShowOnlyRunning();
             var selectedSourceCode = this.View.getActiveSource().id;
             var selectedTargetCode = this.View.getActiveTarget().id;
             var showable = this.systemList.filter(function (elem){
                 var sourceCode = elem.source.id;
                 var targetCode = elem.target.id;
                 var systemStatus = elem.status.id;
                 return sourceCode == selectedSourceCode
                     && targetCode == selectedTargetCode
                      &&((systemStatus in this._runningStatuses) || !showOnlyRunning);
             }.bind(this));
             this.View.setSystems(showable);
             this.View.triggerSystemChange();
         },

         _fillTargetLanguages: function () {
             var directions = this.directions;
             var source = this.View.getActiveSource();
             var prevTarget = this.View.getActiveTarget();
             var targetChoices = directions[source.id].target;
             var sortedTargetCodes = [];
             for (var targetCode in targetChoices) {
                 sortedTargetCodes.push(targetCode);
             }
             sortedTargetCodes.sort();
             var targetLangs = sortedTargetCodes.map(function(code){
                 return new Language(code, targetChoices[code]);
             });
             this.View.setTargets(targetLangs);
             if (prevTarget && prevTarget.id in targetChoices){
                 this.View.setActiveTarget(prevTarget.id);
             } else {
                 this.View.triggerTargetChange();
             }
         },

         createFilters: function(systemList) {
             this.View.hideInitial();
             this.View.showConfig();
             var prevSource = this.View.getActiveSource();
             var prevTarget = this.View.getActiveTarget();
             var showOnlyRunning = this.View.getActiveShowOnlyRunning();
             // a mapping from available source languages to respective target languages
             this.directions = this._buildDirections(systemList, showOnlyRunning);
             this._fillSourceLangs(this.directions);
             this._fillTargetLanguages();
             if (prevSource && prevSource.id in this.directions) {
                 this.View.setActiveSource(prevSource.id);
             } else {
                 this.View.triggerSourceChange();
             }
             if (prevTarget && prevTarget.id in this.directions) {
                 this.View.setActiveTarget(prevTarget.id);
             } // no else{ .triggerTaretChange();} since that has already been done in some
             // source change callback
             this.loadState();
         },

         loadState: function(){
             var state = this.initialState;
             if (state) {
                 Object.keys(state.systems).forEach(function(key){
                     var systemConfig = state.systems[key];
                     var params = systemConfig.params;
                     var system = this.getSystemById(params.systemID);
                     var options = params.options.split(",");
                     var terms = new Term("", "--");
                     var qe = new Qe(false, false, systemConfig.qeThreshold);
                     options.forEach(function(item){
                         var keyval = item.split("=");
                         if (keyval[0] == "termCorpusId"){
                             terms = new Term(keyval[0], keyval[1]);
                         } else if (keyval[0] == "qe"){
                             qe.use = true;
                         }
                     })
                     system.terms = terms;
                     // unlike for terms, we don't know everything about qe from the options
                     // so don't overwrite the system.qe.available value that comes from the API
                     system.qe.use = qe.use;
                     system.qe.threshold = qe.threshold;
                     this.saveSystem(system);
                 }.bind(this));
                 this.initialState = null;
             }
         },

         renderMTConfigCallback: function() {
             createFilters();
         },

         formatOptions: function(termsCorporaId, useQE, client, clientVersion){
             var options = [];
             // client and clientVersion are expected to be strings. hence the checks
             if (client && client.length && clientVersion && clientVersion.length)
                 {
                     options.push("client=" + client);
                     options.push("version=" + clientVersion);
                 }
             if (termsCorporaId){
                 options.push("termCorpusId=" + termsCorporaId);
             }
             if (useQE){
                 options.push("qe");
             }

             return options.join();
         },

         getClient: function(){
             return pluginClient;
         },

         getVersion: function() {
             return pluginVersion;
         },

         getState: function() {
             var systemConfig = {};
             Object.keys(this.selectedSystems).forEach(function(key){
                 var system = this.selectedSystems[key];
                 system = this.getSystemById(system.systemId);
                 var client = this.getClient();
                 var version = this.getVersion();
                 systemConfig[key] = {
                     qeThreshold: system.qe.threshold,
                     params: {
                        systemID: system.id,
                        options: this.formatOptions(system.terms.id, system.qe.use, client, version),
                     },
                 };
             }.bind(this));
             var clientId = this.View.getClientId();
             var engineName = this.View.getEngineName();
             var state = {
                 "engineName": engineName,
                 "client-id": clientId,
                 "systems": systemConfig,
             };
             return state;
         },

         /* getSystemById: function(systemId){*/
         /* var found = this.systemList.find(function(system){*/
         /* return system.id == systemId;*/
         /* });*/
         /* return found;*/
         /* },*/

         getTermsById: function(termsId){
             var found = this.systemList.find(function(system){
                 return system.id == systemId;
             });
             return found;
         },

         setState: function(state) {
             this.initialState = state;
             this.showInitial();
             if(state){
                 // showConfig() at some point will also execute these two lines
                 // but to not show a flash of the initial screen we execute them
                 // here not waiting on the getSystemList response
                this.View.hideInitial();
                this.View.showConfig();
                this.showConfig();
             }
         },

         showInitial: function(){
             var state = this.initialState;
             if(state){
                this.View.setClientId(state["client-id"]);
                this.View.setEngineName(state.engineName);
             }
             this.View.showInitial();
             this.View.hideConfig();
         },

         onSave: function(){
             if (Object.keys(this.selectedSystems).length){
                 this.fireSavedEvent();
             } else {
                 this.View.setError("No systems selected.");
             }
         },

         fireSavedEvent: function() {
             var state = this.getState();
             // create custom event instance
             var event = new CustomEvent("save", {detail: state});
             // dispatch event
             this.dispatchEvent(event);
         },

         saveAndGetState: function(){
             this.onSave();
             return this.getState();
         },

         onCancel: function(){
             this.View.showInitial();
             this.View.hideConfig();
             this.clearSelections();
             this.fireCancelEvent();
         },

         cancel: function(){  // simply an allias for onCancel()
             this.onCancel();
         },

         clearSelections: function() {
             this.selectedSystems = {};
             this.View.clearSystems();
         },

         fireCancelEvent: function() {
             var event = new CustomEvent("cancel", {detail: state});
             this.dispatchEvent(event);
         },

         onLogout: function(){
             /* this.View.setClientId("");*/
             this.View.showInitial();
             this.View.hideConfig();
             this.clearSelections();
             this.fireLogoutEvent();
         },

         fireLogoutEvent: function(){
             var event = new CustomEvent("logout", {detail: state});
             this.dispatchEvent(event);
         },

         onConfigSubmit: function(){
             this.View.setError("");
             this.saveActiveSystem();
             return false;  // to stop the form submit
         },

         saveActiveSystem: function(){
             var systemId = this.View.getActiveSystem().id;
             var system = this.getSystemById(systemId);
             var terms = this.View.getActiveTerms();
             var useQe = this.View.getActiveUseQe();
             var qeThreshold = this.View.getActiveQeThreshold();
             system.terms = terms;
             system.qe.use = useQe;
             system.qe.threshold = useQe ? qeThreshold : undefined;
             this.saveSystem(system);
         },

         saveSystem: function(system){
             if(this.getSystem(system.source.id, system.target.id)){
                 this.View.updateSystem(system);
             }
             else {
                 this.View.addSystem(system);
             }
             this.setSystem(system.source.id, system.target.id, system.id, system.terms.id, system.qe.use);
         },

         removeClicked: function(event){
             var button = event.target;
             var row = button.parentElement.parentElement;
             var id = row.getAttribute("id");
             var ids = id.split("-")
             row.parentElement.removeChild(row);
             this.setSystem(ids[0], ids[1], undefined);
             event.preventDefault();
             event.stopPropagation();
         },

         onSystemEdit: function(event){
             var row = event.currentTarget;
             var id = row.getAttribute("id");
             var selected = this.selectedSystems[id];
             var system = this.getSystemById(selected.systemId);
             this.View.setActive(system);
         },
     };

     MyElementProto.__proto__ = HTMLElement.prototype;

     // Registers <tildemt-selector> in the main document
     window.MyElement = thatDoc.registerElement('tildemt-selector', {
         prototype: MyElementProto
     });
 })(window, document);
</script>
